<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>RSI Customer • Vessel Info</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote.min.css" rel="stylesheet" />

  <!-- Ripple + Customer CSS -->
  <link href="../assets/ripple.css" rel="stylesheet" />
  <link href="page.css" rel="stylesheet" />

  <style>
    body {
      padding-bottom: 80px;
      /* space for sticky footer */
      font-family: "Overpass", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    .top-nav {
      background: #fff;
      border: 1px solid #E6ECF3;
      border-radius: 12px;
      padding: 10px 14px;
      margin: 0 0 16px;
      box-shadow: 0 2px 6px rgba(7, 10, 26, .06);
    }

    .top-nav .title {
      font-weight: 600;
      margin: 4px 0 4px;
    }

    .text-muted-2 {
      color: #6B84A8;
    }

    .panel-body.scrollable-panel {
      padding: 0;
    }

    #journeyBlocksContainer {
      max-height: 65vh;
      overflow-y: auto;
      padding: 15px;
    }

    .journey-block {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 20px;
      background-color: #fafafa;
      position: relative;
    }

    .journey-block .remove-block-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      z-index: 10;
    }

    .note-editor .note-editable {
      height: 220px !important;
      overflow-y: auto !important;
    }

    .image-upload-area {
      height: 220px;
      border: 2px dashed #ddd;
      border-radius: 4px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      background-color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      position: relative;
      margin-bottom: 0;
    }

    .image-upload-area:hover {
      border-color: #337ab7;
      background-color: #f9f9ff;
    }

    .image-preview-container .img-thumbnail-wrapper {
      position: relative;
      display: inline-block;
    }

    .image-preview-container img {
      max-width: 100%;
      max-height: 180px;
      object-fit: contain;
    }

    .remove-img-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #d9534f;
      color: white;
      border: 1px solid white;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      line-height: 20px;
      font-size: 12px;
      cursor: pointer;
      z-index: 5;
    }

    .preview-content {
      border: 1px solid #e3e3e3;
      background-color: #fff;
      padding: 6px 12px;
      min-height: 150px;
      border-radius: 4px;
      overflow-x: auto;
    }

    .preview-images img {
      width: 100%;
      height: auto;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    #clientPreviewModal .modal-body {
      min-height: 400px;
    }

    #preview-image-col {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 350px;
      background-color: #f9f9f9;
      border-radius: 4px;
    }

    #preview-image-col img {
      max-width: 100%;
      max-height: 350px;
      object-fit: contain;
    }

    #preview-content-col {
      min-height: 350px;
      overflow-y: auto;
      max-height: 350px;
    }

    .sticky-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #ddd;
      padding: 8px 15px;
      z-index: 1030;
    }

    .footer-container {
      max-width: 1200px;
      margin: 0 auto;
    }
  </style>
</head>

<body>
  <div class="container-fluid dashboard-layout">
    <div class="row">
      <div id="sidebar-placeholder"></div>

      <div class="col-sm-9 col-md-10 main-content">
        <div class="page-header">
          <h2 id="vesselTitle">Vessel Configuration</h2>
          <p>Maintain vessel details to ensure accurate information is displayed in the crew portal.</p>
        </div>

        <!-- Editing vessel selector (single) -->
        <div class="row">
          <div class="col-sm-12">
            <div class="top-nav">
              <div class="row">
                <div class="col-sm-2">
                  <div class="title">
                    <i class="fa fa-ship text-primary"></i> Editing vessel
                    <i class="fa fa-info-circle text-muted" data-toggle="tooltip" data-placement="top"
                      title="Choose a vessel to view and edit its Visual Journey and Embarkation details."></i>
                  </div>
                </div>
                <div class="col-sm-10">
                  <select class="form-control" id="editing-vessel"></select>
                  <p class="text-muted" style="font-style: italic; margin-top: 2px; font-size: smaller;">
                    You are editing this vessel’s content. Use “Apply to other vessels” to reuse the same setup.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Visual Journey -->
        <div class="panel panel-default">
          <div class="panel-heading">
            <i class="fa fa-ship"></i> Visual Journey Aboard
            <button id="addBlockBtn" class="btn btn-primary btn-xs pull-right">
              <i class="fa fa-plus"></i> Add Block
            </button>
          </div>
          <div class="panel-body scrollable-panel">
            <div id="journeyBlocksContainer"></div>
          </div>
        </div>

        <!-- Embarkation (commented out for now)
        <div class="panel panel-default">
          <div class="panel-heading"><i class="fa fa-anchor"></i> Next Embarkation Schedule</div>
          <div class="panel-body">
            <div class="row">
              <div class="col-sm-4 form-group">
                <label>Embarkation Date</label>
                <input type="date" id="embarkDate" class="form-control">
              </div>
              <div class="col-sm-4 form-group">
                <label>Embarkation Time</label>
                <input type="time" id="embarkTime" class="form-control">
              </div>
              <div class="col-sm-4 form-group">
                <label>Embarkation Location</label>
                <input type="text" id="embarkLocation" class="form-control" placeholder="e.g. Manila Port">
              </div>
            </div>
          </div>
        </div>
        -->

      </div> <!-- /.main-content -->
    </div>
  </div>

  <!-- Sticky footer -->
  <div class="sticky-footer">
    <div class="footer-container">
      <div class="row">
        <!-- LEFT: Apply to other vessels -->
        <div class="col-xs-6">
          <button id="applyConfigBtn" class="btn btn-default btn-sm">
            <i class="fa fa-clone"></i> Apply to other vessels…
          </button>
        </div>

        <!-- RIGHT: Preview + primary Save/Edit -->
        <div class="col-xs-6">
          <div class="row">
            <div class="col-xs-6">
              <button id="previewBtn" class="btn btn-info btn-block btn-sm">
                <i class="fa fa-eye"></i> Client Preview
              </button>
            </div>
            <div class="col-xs-6" id="primary-action-wrapper">
              <!-- Filled by JS: Save & Post Changes / Edit Page -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Apply to other vessels modal -->
  <div class="modal fade" id="applyToVesselsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title">Apply configuration to other vessels</h4>
        </div>
        <div class="modal-body">
          <p class="text-muted">
            This will copy the <strong>Visual Journey</strong> and <strong>Next Embarkation</strong> from
            <strong id="apply-source-vessel-name"></strong> to the selected vessels below. Existing data for those
            vessels will be overwritten.
          </p>
          <div class="form-group">
            <label for="apply-vessels-select">Choose vessels to update</label>
            <select id="apply-vessels-select" class="form-control" multiple></select>
            <p class="help-block">You can select one or more vessels. The current editing vessel is excluded.</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="applyConfigConfirmBtn">Apply to selected vessel(s)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Client preview modal -->
  <div class="modal fade" id="clientPreviewModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title">Client Portal Preview</h4>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-sm-6" id="preview-content-col"></div>
            <div class="col-sm-6" id="preview-image-col"></div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="pull-left">
            <button type="button" class="btn btn-default" id="preview-prev-btn">
              <i class="fa fa-chevron-left"></i> Previous
            </button>
          </div>
          <div class="pull-right">
            <span id="preview-page-indicator" style="margin: 0 10px; vertical-align: middle;"></span>
            <button type="button" class="btn btn-default" id="preview-next-btn">
              Next <i class="fa fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote.min.js"></script>

  <script>
    $(function () {
      // --- SIDEBAR ---
      fetch('customer-sidebar.html')
        .then(res => res.text())
        .then(data => {
          const sidebarPlaceholder = document.getElementById('sidebar-placeholder');
          sidebarPlaceholder.innerHTML = data;
          const activeLink = sidebarPlaceholder.querySelector('[data-page="customer-vessel-info"]');
          if (activeLink) activeLink.classList.add('active');
        });

      $('[data-toggle="tooltip"]').tooltip();

      // --- GLOBALS & DEFAULT DATA ---
      const VESSEL_CONFIG_KEY = 'vesselConfigs';

      let blockCounter = 0;
      let isEditMode = true;
      let previewBlocksData = [];
      let currentPreviewIndex = 0;
      let currentVesselId = null;

      let vessels = JSON.parse(localStorage.getItem('vessels') || 'null') || [
        { id: 'VES-001', name: 'M/V Ocean Explorer' },
        { id: 'VES-002', name: 'M/V Yurisan Dozo' },
        { id: 'VES-003', name: 'M/V Ripple Star' }
      ];
      localStorage.setItem('vessels', JSON.stringify(vessels));

      let vesselConfigs = JSON.parse(localStorage.getItem(VESSEL_CONFIG_KEY) || '{}');

      // Default sample for M/V Yurisan Dozo
      const defaultPageData = {
        embarkation: {
          date: "2025-11-15",
          time: "09:00",
          location: "Cebu Port"
        },
        journey: [
          {
            content: '<h1>Vessel Overview: M/V Yurisan Dozo</h1><p>The <b>M/V Yurisan Dozo</b> is a modern general cargo vessel designed for maximum efficiency and compliance with the latest international maritime standards. It is equipped to handle a wide variety of cargo types, including bulk, containers, and project cargo.</p><ul><li><b>Vessel Type:</b> General Cargo</li><li><b>IMO Number:</b> 9876543</li><li><b>Gross Tonnage:</b> 12,500 GT</li><li><b>Length Overall (LOA):</b> 150.25 m</li><li><b>Beam:</b> 25.5 m</li><li><b>Year Built:</b> 2021</li></ul>',
            image: '../assets/rsi1.png'
          },
          {
            content: '<h2>Crew Accommodations & Amenities</h2><p>Life on board the M/V Yurisan Dozo is designed for comfort and well-being. All crew members are housed in single-berth cabins with private washroom facilities.</p><p>Onboard amenities include:</p><ul><li>A modern gymnasium and fitness area.</li><li>Recreation room with satellite TV and entertainment systems.</li><li>High-speed satellite internet access for crew communication.</li><li>A fully-equipped mess hall serving nutritious meals.</li></ul>',
            image: '../assets/rsi3.1.png'
          },
          {
            content: '<h2>Bridge & Contact Information</h2><p>The vessel is commanded from a state-of-the-art navigation bridge featuring fully integrated systems for enhanced safety and operational efficiency.</p><p><b>Key Equipment:</b> Dual RADAR (X & S-Band), ECDIS, GMDSS, VDR, and Autopilot systems.</p><hr><p><b><u>Important Contacts:</u></b></p><ul><li><b>Bridge Satellite Phone:</b> +88 167 772 1234</li><li><b>Vessel Email:</b> captain.yurisandozo@shiplink.com</li></ul>',
            image: '../assets/rsi2.2.png'
          }
        ]
      };

      // --- DEMO SEED: different content per vessel (only if nothing exists yet) ---
      if (!vesselConfigs || Object.keys(vesselConfigs).length === 0) {
        vesselConfigs = {
          // Ocean Explorer demo content
          'VES-001': {
            embarkation: {
              date: "2025-12-01",
              time: "14:30",
              location: "Manila International Port"
            },
            journey: [
              {
                content: '<h1>Vessel Overview: M/V Ocean Explorer</h1><p>The <b>M/V Ocean Explorer</b> is a passenger vessel designed for coastal exploration cruises with a focus on guest comfort and scenic itineraries.</p><ul><li><b>Vessel Type:</b> Expedition Cruise</li><li><b>Guest Capacity:</b> 220 passengers</li><li><b>Cabins:</b> 110 outside cabins, most with balconies</li><li><b>Special Feature:</b> 270° observation lounge at the bow</li></ul>',
                image: '../assets/rsi2.2.png'
              },
              {
                content: '<h2>Guest Experience Highlights</h2><p>Guests can enjoy multiple dining options, lecture rooms for enrichment programs, and open deck spaces for wildlife and aurora viewing.</p><ul><li>All-day buffet restaurant with ocean views</li><li>Observation deck with heated benches</li><li>Onboard expedition team and zodiac landings</li></ul>',
                image: '../assets/rsi3.1.png'
              }
            ]
          },
          // Yurisan Dozo demo content (your main example)
          'VES-002': defaultPageData,
          // Ripple Star demo content
          'VES-003': {
            embarkation: {
              date: "2025-11-20",
              time: "18:00",
              location: "Osaka Port"
            },
            journey: [
              {
                content: '<h1>Vessel Overview: M/V Ripple Star</h1><p><b>M/V Ripple Star</b> is a modern Ro-Ro vessel serving mixed cargo and vehicle lanes across multiple Asian ports.</p><ul><li><b>Vessel Type:</b> Ro-Ro / General Cargo</li><li><b>Trading Area:</b> Japan – Korea – Philippines</li><li><b>Decks:</b> 5 vehicle decks with adjustable ramps</li></ul>',
                image: '../assets/rsi1.png'
              },
              {
                content: '<h2>Crew & Safety Familiarization</h2><p>All newly-joining crew undergo a digital familiarization sequence in Ripple Smart Induction before embarkation.</p><ul><li>Step-by-step cargo operations overview</li><li>Vehicle deck safety checkpoints</li><li>Emergency muster and evacuation routes</li></ul>',
                image: '../assets/rsi3.1.png'
              }
            ]
          }
        };
        localStorage.setItem(VESSEL_CONFIG_KEY, JSON.stringify(vesselConfigs));

        // Also keep global fallback aligned with Yurisan sample
        localStorage.setItem('vesselPageData', JSON.stringify(defaultPageData));
      }

      // --- HELPERS ---
      function showAlert(msg, type = 'success') {
        const alert = $(
          `<div class="alert alert-${type}" style="position:fixed;top:20px;right:20px;z-index:9999;">${msg}</div>`
        );
        $('body').append(alert);
        setTimeout(() => alert.fadeOut(500, () => alert.remove()), 3000);
      }

      function updateImageThumbnail(src, $container) {
        $container.empty().append(`
          <div class="img-thumbnail-wrapper">
            <img src="${src}" />
            <button class="remove-img-btn">&times;</button>
          </div>`);
        $container.siblings('.upload-text').hide();
      }

      function toggleRemoveButtons() {
        $('.journey-block .remove-block-btn').toggle($('.journey-block').length > 1);
      }

      function toggleViewMode(editMode) {
        isEditMode = editMode;
        // Embarkation inputs are commented out in HTML; this will just no-op.
        $('#embarkDate, #embarkTime, #embarkLocation').prop('disabled', !editMode);

        if (editMode) {
          $('#addBlockBtn').prop('disabled', false);
          $('.edit-view').show();
          $('.preview-view').hide();
          $('.remove-block-btn').show();
          toggleRemoveButtons();
          $('#primary-action-wrapper').html(
            '<button id="saveAllBtn" class="btn btn-success btn-block btn-sm"><i class="fa fa-save"></i> Save &amp; Post Changes</button>'
          );
        } else {
          $('#addBlockBtn').prop('disabled', true);
          updateAllPreviews();
          $('.edit-view').hide();
          $('.preview-view').show();
          $('.remove-block-btn').hide();
          $('#primary-action-wrapper').html(
            '<button id="editAllBtn" class="btn btn-primary btn-block btn-sm"><i class="fa fa-pencil"></i> Edit Page</button>'
          );
        }
      }

      function addBlock(data = {}) {
        const id = blockCounter++;
        const blockId = `journey-block-${id}`;
        const inputId = `image-input-${id}`;
        const content = data.content || '';
        const image = data.image || null;

        const blockHTML = `
          <div class="journey-block" id="${blockId}" data-block-id="${id}">
            <button class="btn btn-danger btn-xs remove-block-btn"><i class="fa fa-trash"></i></button>
            <div class="edit-view">
              <div class="row">
                <div class="col-md-6">
                  <label>Content</label>
                  <textarea class="rich-text-editor"></textarea>
                </div>
                <div class="col-md-6">
                  <label>Image</label>
                  <label for="${inputId}" class="image-upload-area">
                    <input type="file" id="${inputId}" class="image-input" accept="image/*" style="display: none;" />
                    <div class="image-preview-container"></div>
                    <div class="upload-text">
                      <i class="fa fa-cloud-upload fa-2x"></i>
                      <p>Click to upload a single image</p>
                    </div>
                  </label>
                </div>
              </div>
            </div>
            <div class="preview-view" style="display: none;">
              <div class="row">
                <div class="col-md-6"><div class="preview-content"></div></div>
                <div class="col-md-6"><div class="preview-images"></div></div>
              </div>
            </div>
          </div>
        `;
        $('#journeyBlocksContainer').append(blockHTML);
        const $currentBlock = $(`#${blockId}`);

        $currentBlock.find('.rich-text-editor').summernote({
          height: 220,
          toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'italic', 'underline', 'clear']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['insert', ['link']],
            ['view', ['codeview']]
          ]
        }).summernote('code', content);

        if (image) {
          updateImageThumbnail(image, $currentBlock.find('.image-preview-container'));
        }

        toggleRemoveButtons();
      }

      function updateAllPreviews() {
        $('.journey-block').each(function () {
          const $block = $(this);
          const content = $block.find('.rich-text-editor').summernote('code');
          const image = $block.find('.image-preview-container img').attr('src');

          $block.find('.preview-content').html(content.trim() === "" ? '<p class="text-muted">No content.</p>' : content);

          const $previewImages = $block.find('.preview-images').empty();
          if (image) {
            $previewImages.append(`<img src="${image}" class="img-responsive thumbnail">`);
          } else {
            $previewImages.html('<p class="text-muted">No image.</p>');
          }
        });
      }

      function collectPageData() {
        const journeyData = [];
        $('.journey-block').each(function () {
          const content = $(this).find('.rich-text-editor').summernote('code');
          const image = $(this).find('.image-preview-container img').attr('src') || null;
          journeyData.push({ content, image });
        });

        // Embarkation is kept in the model but currently not shown in UI.
        const embarkationData = {
          date: $('#embarkDate').val() || "",
          time: $('#embarkTime').val() || "",
          location: $('#embarkLocation').val() || ""
        };

        return {
          journey: journeyData,
          embarkation: embarkationData
        };
      }

      function clearBlocks() {
        $('#journeyBlocksContainer').empty();
        blockCounter = 0;
      }

      function deepCopy(obj) {
        return JSON.parse(JSON.stringify(obj || {}));
      }

      function getVesselName(id) {
        const v = vessels.find(v => v.id === id);
        return v ? v.name : id;
      }

      function loadConfigForCurrentVessel() {
        if (!currentVesselId) return;
        clearBlocks();

        const allConfigs = vesselConfigs || {};
        let cfg = allConfigs[currentVesselId];

        if (!cfg) {
          const global = JSON.parse(localStorage.getItem('vesselPageData') || 'null');
          cfg = global || defaultPageData;
        }

        // Embarkation part kept but not visible in UI.
        if (cfg.embarkation) {
          $('#embarkDate').val(cfg.embarkation.date || "");
          $('#embarkTime').val(cfg.embarkation.time || "");
          $('#embarkLocation').val(cfg.embarkation.location || "");
        } else {
          $('#embarkDate').val("");
          $('#embarkTime').val("");
          $('#embarkLocation').val("");
        }

        if (cfg.journey && cfg.journey.length > 0) {
          cfg.journey.forEach(blockData => addBlock(blockData));
        } else {
          addBlock();
        }

        const hasSavedConfig = !!vesselConfigs[currentVesselId];
        toggleViewMode(!hasSavedConfig ? true : false);
      }

      function saveAllData() {
        if (!currentVesselId) {
          showAlert('No vessel selected.', 'warning');
          return;
        }
        const pageData = collectPageData();

        vesselConfigs[currentVesselId] = deepCopy(pageData);
        localStorage.setItem(VESSEL_CONFIG_KEY, JSON.stringify(vesselConfigs));
        localStorage.setItem('vesselPageData', JSON.stringify(pageData));

        showAlert('All changes have been saved for ' + getVesselName(currentVesselId) + '!', 'success');
        toggleViewMode(false);
      }

      // --- APPLY TO OTHER VESSELS ---
      function openApplyModal() {
        if (!currentVesselId) {
          showAlert('Select a vessel to edit first.', 'warning');
          return;
        }

        const pageData = collectPageData();
        vesselConfigs[currentVesselId] = deepCopy(pageData);
        localStorage.setItem(VESSEL_CONFIG_KEY, JSON.stringify(vesselConfigs));
        localStorage.setItem('vesselPageData', JSON.stringify(pageData));

        $('#apply-source-vessel-name').text(getVesselName(currentVesselId));

        const $sel = $('#apply-vessels-select').empty();
        vessels.forEach(v => {
          if (v.id !== currentVesselId) {
            $sel.append('<option value="' + v.id + '">' + v.name + '</option>');
          }
        });

        $sel.val(null);
        $('#applyToVesselsModal').modal('show');
      }

      function applyConfigToTargets() {
        const targets = $('#apply-vessels-select').val() || [];
        if (!targets.length) {
          showAlert('Please select at least one vessel to apply to.', 'warning');
          return;
        }

        const sourceData = vesselConfigs[currentVesselId] || collectPageData();
        const copyData = deepCopy(sourceData);
        targets.forEach(id => {
          vesselConfigs[id] = deepCopy(copyData);
        });
        localStorage.setItem(VESSEL_CONFIG_KEY, JSON.stringify(vesselConfigs));

        // Optional: log to shared activity
        try {
          let activityLog = JSON.parse(localStorage.getItem('customerActivityLog') || '[]');
          activityLog.unshift({
            icon: 'fa-copy',
            action: 'Applied vessel configuration from <strong>' + getVesselName(currentVesselId) + '</strong> to ' + targets.length + ' vessel(s).',
            ts: Date.now()
          });
          if (activityLog.length > 50) activityLog = activityLog.slice(0, 50);
          localStorage.setItem('customerActivityLog', JSON.stringify(activityLog));
        } catch (err) {
          console.warn('Could not append to activity log', err);
        }

        $('#applyToVesselsModal').modal('hide');
        showAlert('Configuration applied to ' + targets.length + ' vessel(s).', 'success');
      }

      // --- PREVIEW MODAL ---
      function launchPreviewModal() {
        previewBlocksData = [];
        $('.journey-block').each(function () {
          const content = $(this).find('.rich-text-editor').summernote('code');
          const image = $(this).find('.image-preview-container img').attr('src') || null;
          previewBlocksData.push({ content, image });
        });

        if (previewBlocksData.length === 0) {
          showAlert('Add at least one block to preview.', 'warning');
          return;
        }
        currentPreviewIndex = 0;
        renderPreviewSlide(currentPreviewIndex);
        $('#clientPreviewModal').modal('show');
      }

      function renderPreviewSlide(index) {
        const slideData = previewBlocksData[index];
        $('#preview-content-col').html(slideData.content);
        if (slideData.image) {
          $('#preview-image-col').html(`<img src="${slideData.image}" alt="Vessel Journey Image">`);
        } else {
          $('#preview-image-col').html('<p class="text-muted">No Image Provided</p>');
        }
        $('#preview-page-indicator').text(`Page ${index + 1} of ${previewBlocksData.length}`);
        $('#preview-prev-btn').prop('disabled', index === 0);
        $('#preview-next-btn').prop('disabled', index === previewBlocksData.length - 1);
      }

      // --- VESSEL SELECT INIT ---
      function initEditingVesselSelect() {
        const $sel = $('#editing-vessel').empty();
        vessels.forEach(v => $sel.append('<option value="' + v.id + '">' + v.name + '</option>'));

        const storedId = localStorage.getItem('currentVesselId');
        if (storedId && vessels.some(v => v.id === storedId)) {
          currentVesselId = storedId;
        } else if (vessels.some(v => v.id === 'VES-002')) {
          // Default to M/V Yurisan Dozo for demo
          currentVesselId = 'VES-002';
        } else if (vessels.length) {
          currentVesselId = vessels[0].id;
        }

        $sel.val(currentVesselId);

        $sel.select2({
          placeholder: 'Select a vessel to edit',
          width: '100%'
        });

        $sel.on('change', function () {
          currentVesselId = $(this).val();
          localStorage.setItem('currentVesselId', currentVesselId);
          loadConfigForCurrentVessel();
        });
      }

      // --- EVENTS ---
      $('#addBlockBtn').on('click', () => addBlock());

      $('#primary-action-wrapper')
        .on('click', '#saveAllBtn', saveAllData)
        .on('click', '#editAllBtn', () => toggleViewMode(true));

      $('#previewBtn').on('click', launchPreviewModal);
      $('#applyConfigBtn').on('click', openApplyModal);
      $('#applyConfigConfirmBtn').on('click', applyConfigToTargets);

      $('#journeyBlocksContainer').on('click', '.remove-block-btn', function () {
        $(this).closest('.journey-block').remove();
        toggleRemoveButtons();
      });

      $('#journeyBlocksContainer').on('change', '.image-input', function (e) {
        if (e.target.files && e.target.files[0]) {
          const file = e.target.files[0];
          const $previewContainer = $(this).siblings('.image-preview-container');
          const reader = new FileReader();
          reader.onload = (event) => { updateImageThumbnail(event.target.result, $previewContainer); };
          reader.readAsDataURL(file);
        }
      });

      $('#journeyBlocksContainer').on('click', '.remove-img-btn', function (e) {
        e.preventDefault();
        const $uploadArea = $(this).closest('.image-upload-area');
        $uploadArea.find('.image-preview-container').empty();
        $uploadArea.find('.upload-text').show();
        $uploadArea.find('.image-input').val('');
      });

      $('#preview-next-btn').on('click', function () {
        if (currentPreviewIndex < previewBlocksData.length - 1) { renderPreviewSlide(++currentPreviewIndex); }
      });
      $('#preview-prev-btn').on('click', function () {
        if (currentPreviewIndex > 0) { renderPreviewSlide(--currentPreviewIndex); }
      });

      // --- INIT ---
      initEditingVesselSelect();
      loadConfigForCurrentVessel();
    });
  </script>

</body>

</html>
