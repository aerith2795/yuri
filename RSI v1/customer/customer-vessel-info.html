<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>RSI Customer • Vessel Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Libs -->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

  <!-- Summernote (Rich Text Editor) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote.min.css" rel="stylesheet" />

  <!-- Ripple + Customer CSS -->
  <link href="../assets/ripple.css" rel="stylesheet" />
  <link href="page.css" rel="stylesheet" />

  <style>
    /* Keep the vessel images a consistent height and look */
    .vessel-carousel img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 6px;
      display: block;
    }

    /* Small thumbnail preview row */
    .thumb-row { margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap; }
    .thumb-row img { width:80px; height:60px; object-fit:cover; border-radius:4px; border:1px solid #e1e4ea; }

    /* Success alert placement */
    .save-alert { margin-top:10px; display:none; }
  </style>
</head>

<body>
  <div class="container-fluid dashboard-layout">
    <div class="row">
      <!-- Sidebar placeholder (optional) -->
      <div id="sidebar-placeholder"></div>

      <!-- Main -->
      <div class="col-sm-9 col-md-10 main-content">
        <div class="page-header">
          <h2>Vessel Configuration</h2>
          <p>Setup vessel information and configure how it will appear in the Client Portal.</p>
        </div>

        <!-- Vessel Info -->
        <div class="panel">
          <div class="panel-heading">
            <i class="fa fa-ship"></i> M/V Yurisan Dozo
            <button class="btn btn-primary btn-sm pull-right" data-toggle="collapse" data-target="#vesselInfoForm" aria-expanded="false" aria-controls="vesselInfoForm">
              <i class="fa fa-pencil"></i> Add/Edit Info
            </button>
          </div>
          <div class="panel-body">

            <!-- Edit Form (collapsible, user can keep open manually) -->
            <div id="vesselInfoForm" class="collapse">
              <form id="vesselForm" novalidate>
                <div class="form-group">
                  <label>About the Vessel</label>
                  <textarea id="aboutVessel" class="form-control rich-text"></textarea>
                </div>

                <div class="form-group">
                  <label>Upload Vessel Photos (Max 5)</label>
                  <input type="file" id="vesselPhotos" class="form-control" accept="image/*" multiple />
                  <p class="help-block">Upload up to 5 images. Recommended size: 800x500px.</p>

                  <!-- Live thumbnail previews -->
                  <div id="thumbs" class="thumb-row" aria-live="polite"></div>
                </div>

                <button type="submit" class="btn btn-success">
                  <i class="fa fa-save"></i> Save
                </button>

                <div class="alert alert-success save-alert" id="saveSuccess">
                  <i class="fa fa-check-circle"></i> Vessel info updated.
                </div>
              </form>
              <hr />
            </div>

            <!-- Preview Section -->
            <div class="row">
              <!-- About Vessel -->
              <div class="col-md-6">
                <h4><i class="fa fa-info-circle"></i> About the Vessel</h4>
                <div id="aboutPreview" class="well">
                  <p>No information added yet. Click <b>Add/Edit Info</b> to update.</p>
                </div>
              </div>

              <!-- Vessel Photos -->
              <div class="col-md-6">
                <h4><i class="fa fa-picture-o"></i> Vessel Gallery</h4>
                <div id="vesselCarousel" class="carousel slide vessel-carousel" data-ride="carousel">
                  <ol class="carousel-indicators"></ol>
                  <div class="carousel-inner">
                    <div class="item active">
                      <img src="https://via.placeholder.com/800x500?text=No+Photo" alt="No photo">
                    </div>
                  </div>

                  <!-- Controls -->
                  <a class="left carousel-control" href="#vesselCarousel" data-slide="prev">
                    <span class="glyphicon glyphicon-chevron-left"></span>
                  </a>
                  <a class="right carousel-control" href="#vesselCarousel" data-slide="next">
                    <span class="glyphicon glyphicon-chevron-right"></span>
                  </a>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Activity Logs Config -->
        <div class="panel">
          <div class="panel-heading">
            <i class="fa fa-history"></i> Configure Activity Logs/History
          </div>
          <div class="panel-body">
            <div class="row">
              <div class="col-sm-4 form-group">
                <label>Number of logs to display</label>
                <input type="number" id="logCount" class="form-control" min="1" max="20" value="5">
              </div>
              <div class="col-sm-8 form-group">
                <label>Columns to display</label>
                <select id="logColumns" class="form-control select2" multiple>
                  <option value="activity" selected>Activity</option>
                  <option value="vessel">Vessel</option>
                  <option value="embark">Embark Date</option>
                  <option value="disembark">Disembark Date</option>
                  <option value="location">Location</option>
                </select>
              </div>
            </div>
            <button id="saveLogs" class="btn btn-success"><i class="fa fa-save"></i> Save Logs Config</button>
            <hr />

            <!-- Preview Table -->
            <h4>Preview (Client Portal)</h4>
            <table class="table table-bordered" id="logsPreview">
              <thead>
                <tr></tr>
              </thead>
              <tbody>
                <tr><td colspan="4" class="text-center text-muted">Sample activity logs will appear here</td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div><!-- /main -->
    </div>
  </div>

  <!-- JS libs -->
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>

  <!-- Summernote -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote.min.js"></script>

  <script>
    $(function () {
      // Load sidebar (optional)
      fetch('customer-sidebar.html')
        .then(response => response.text())
        .then(data => {
          $('#sidebar-placeholder').html(data);
          const currentPage = 'customer-vessel-info';
          const activeLink = $('#sidebar-placeholder').find(`[data-page="${currentPage}"]`);
          if (activeLink.length) activeLink.addClass('active');
        }).catch(()=>{/*silent if not available*/});

      // Init select2
      $('.select2').select2({ tags: true });

      // Init Summernote
      $('#aboutVessel').summernote({
        height: 150,
        placeholder: 'Describe your vessel here...'
      });

      // Helper: check if Summernote content is empty
      function isSummernoteEmpty(html) {
        const tmp = $('<div>').html(html).text().trim();
        // Summernote default empty can be "<p><br></p>" — check trimmed text and any images
        return tmp.length === 0 && $(html).find('img').length === 0;
      }

      // Build carousel (indicators + inner) from an array of image dataURLs
      function buildCarousel(images) {
        const $carousel = $('#vesselCarousel');
        const $inner = $carousel.find('.carousel-inner').empty();
        const $ind = $carousel.find('.carousel-indicators').empty();

        if (!images || images.length === 0) {
          $ind.append('<li data-target="#vesselCarousel" data-slide-to="0" class="active"></li>');
          $inner.append(`<div class="item active"><img src="https://via.placeholder.com/800x500?text=No+Photo" alt="No photo"></div>`);
        } else {
          images.forEach((src, idx) => {
            $ind.append(`<li data-target="#vesselCarousel" data-slide-to="${idx}" ${idx === 0 ? 'class="active"' : ''}></li>`);
            $inner.append(`<div class="item ${idx === 0 ? 'active' : ''}"><img src="${src}" alt="Vessel photo ${idx+1}"></div>`);
          });
        }
        // restart carousel at first item
        try {
          $carousel.carousel(0);
        } catch (e) { /* ignore */ }
      }

      // Convert FileList -> Promise array of dataURL strings (preserves order)
      function readFilesAsDataURLs(fileList, max = 5) {
        const files = Array.from(fileList || []).slice(0, max);
        const promises = files.map(file => new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error('Failed to read file'));
          reader.readAsDataURL(file);
        }));
        return Promise.all(promises);
      }

      // Show small thumbnails when files selected
      $('#vesselPhotos').on('change', function () {
        const files = this.files || [];
        const $thumbs = $('#thumbs').empty();
        if (files.length > 5) {
          alert('Maximum 5 images allowed. Only the first 5 will be used.');
        }
        // preview up to 5
        Array.from(files).slice(0, 5).forEach(file => {
          const reader = new FileReader();
          reader.onload = e => {
            $thumbs.append(`<img src="${e.target.result}" alt="thumb">`);
          };
          reader.readAsDataURL(file);
        });

        // update carousel live (so user sees immediate preview)
        readFilesAsDataURLs(files, 5).then(images => buildCarousel(images)).catch(()=>{/*ignore*/});
      });

      // Save button (submit) - updates preview content and carousel reliably
      $('#vesselForm').on('submit', function (e) {
        e.preventDefault();

        // About HTML from Summernote
        const aboutHtml = $('#aboutVessel').summernote('code');

        if (isSummernoteEmpty(aboutHtml)) {
          $('#aboutPreview').html('<p class="text-muted">No information provided yet.</p>');
        } else {
          $('#aboutPreview').html(aboutHtml);
        }

        // Images
        const files = $('#vesselPhotos')[0].files || [];
        if (files.length === 0) {
          // nothing selected => keep existing carousel (or placeholder)
          buildCarousel([]);
          $('#thumbs').empty();
        } else {
          // read files (max 5), then build carousel
          readFilesAsDataURLs(files, 5)
            .then(images => {
              buildCarousel(images);
            })
            .catch(err => {
              console.error(err);
              alert('Error reading image files.');
            });
        }

        // show success feedback
        $('#saveSuccess').stop(true, true).fadeIn(200).delay(1600).fadeOut(800);
      });

      // Logs preview logic (keeps as before)
      function updateLogsPreview() {
        const cols = $('#logColumns').val() || [];
        const headRow = $('#logsPreview thead tr').empty();
        if (!cols.length) {
          headRow.append('<th>No columns selected</th>');
          $('#logsPreview tbody').html('<tr><td class="text-muted text-center">No data</td></tr>');
          return;
        }
        cols.forEach(col => {
          const label = col.charAt(0).toUpperCase() + col.slice(1);
          headRow.append(`<th>${label.replace(/([A-Z])/g, ' $1').trim()}</th>`);
        });
        const count = Math.max(1, parseInt($('#logCount').val(), 10) || 5);
        const sample = Array.from({ length: count }, (_, i) =>
          `<tr>${cols.map(c => `<td>Sample ${c} ${i + 1}</td>`).join('')}</tr>`
        ).join('');
        $('#logsPreview tbody').html(sample);
      }

      $('#logColumns, #logCount').on('change input', updateLogsPreview);
      updateLogsPreview();
    });
  </script>
</body>

</html>
