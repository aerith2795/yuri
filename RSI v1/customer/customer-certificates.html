<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>RSI Customer • Certificates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <link href="../assets/ripple.css" rel="stylesheet" />
  <link href="page.css" rel="stylesheet" />
  <style>
   
    .form-grid.columns-2 .form-group {
      width: 48%;
      display: inline-block;
      vertical-align: top;
      margin-right: 4%;
    }

    .form-grid.columns-2 .form-group:nth-child(2n) {
      margin-right: 0;
    }
  </style>
</head>

<body>
  <div class="container-fluid dashboard-layout">
    <div class="row">
      <div id="sidebar-placeholder"></div>

      <div class="col-sm-9 col-md-10 main-content">
        <div class="page-header">
          <h2>Certificates Configuration</h2>
          <p>Define which certificates are required from crew during registration.</p>
        </div>

        <div class="panel">
          <div class="col-sm-12">
            <!-- <div class="panel-body"> -->
            <h3>82% <small>storage used</small> <i class="fa fa-info-circle small" data-toggle="tooltip"
                title="You have used 82% of your storage quota."></i></h3>
            <div class="progress">
              <div class="progress-bar progress-bar-info" style="width:82%"></div>
            </div>
            <!-- </div> -->
          </div>
          <div class="panel-heading">
            <i class="fa fa-list"></i> Certificates
            <button class="btn btn-primary btn-xs pull-right" id="btnAddCert"><i class="fa fa-plus"></i> Add
              Certificate</button>
          </div>

          <div class="panel-body">
            <div class="form-group">
              <label>General Instructions (displayed above crew page)</label>
              <textarea id="certInstructions" class="form-control" rows="2"
                placeholder="e.g., Please upload clear, readable copies."></textarea>
            </div>

            <table class="table table-bordered" id="certTable">
              <thead>
                <tr>
                  <th style="width: 20%">Name (crew sees)</th>
                  <th style="width: 12%">Type</th>
                  <th style="width: 12%">Code</th>
                  <th style="width: 14%">Category</th>
                  <th>Description</th>
                  <th style="width: 9%">Required</th>
                  <th style="width: 9%">Upload</th>
                  <th style="width: 12%">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <hr />
            <button id="saveChanges" class="btn btn-primary"><i class="fa fa-save"></i> Save & Post Changes</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit modal -->
  <div class="modal fade" id="modalCert" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="formCert">
          <div class="modal-header">
            <h4 class="modal-title">Add / Edit Certificate</h4>
          </div>
          <div class="modal-body">
            <input type="hidden" id="certRowIndex" value="">
            <div class="form-group">
              <label>Certificate Name</label>
              <input id="certName" type="text" class="form-control" placeholder="Certificate name">
            </div>
            <div class="form-group">
              <label>Category</label>
              <input id="certCategory" type="text" class="form-control" placeholder="Identity / Health / Safety">
            </div>

            <div class="form-grid columns-2">
              <div class="form-group">
                <label>Type</label>
                <input id="certType" type="text" class="form-control" placeholder="Document / Medical / Training">
              </div>
              <div class="form-group">
                <label>Code</label>
                <input id="certCode" type="text" class="form-control" placeholder="e.g. SBK-01">
              </div>

              <div class="form-group">
                <label>Allowed File Type</label>
                <select id="certAllowedFileType" class="form-control">
                  <option value="any">Any</option>
                  <option value="pdf">PDF</option>
                  <option value="image">Image (jpg/png)</option>
                  <option value="doc">Word/Doc</option>
                </select>
              </div>

              <div class="form-group">
                <label>Max File Size (MB)</label>
                <input id="certMaxSize" type="number" class="form-control" value="5" min="1">
              </div>
            </div>

            <div class="checkbox"><label><input id="certIsRequired" type="checkbox"> Required Document</label></div>
            <div class="checkbox"><label><input id="certRequireUpload" type="checkbox"> Required to Upload</label></div>

            <div class="form-group">
              <label>Description</label>
              <textarea id="certDesc" class="form-control" rows="2"></textarea>
            </div>
            <div class="form-group">
              <label>Instructions for Crew</label>
              <textarea id="certInstructionsPerCert" class="form-control" rows="2"></textarea>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Certificate</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>

  <script>
    $(function () {
      $('.select2').select2();

      // load sidebar
      fetch('customer-sidebar.html').then(r => r.text()).then(html => {
        $('#sidebar-placeholder').html(html);
        const active = $('#sidebar-placeholder').find('[data-page="customer-certificates"]');
        if (active.length) active.addClass('active');
      });

      // --- Robust vesselConfigCert initialization ---
      if (typeof window.vesselConfigCert === 'undefined' || !window.vesselConfigCert) {
        window.vesselConfigCert = {};
      }

      let stored = localStorage.getItem('vesselConfigCert');
      if (stored) {
        try {
          let parsed = JSON.parse(stored);

          // Detect bad certs (empty, all test/blank)
          let badCerts = !Array.isArray(parsed.certificatesRequired) ||
            !parsed.certificatesRequired.length ||
            parsed.certificatesRequired.every(c =>
              !c.name || c.name.toLowerCase().includes('test')
            );

          if (badCerts) {
            console.warn('Invalid certificate data in localStorage → resetting to defaults');
            localStorage.removeItem('vesselConfigCert');
          } else {
            window.vesselConfigCert = parsed;
          }
        } catch (e) {
          console.warn('Bad vesselConfigCert in localStorage → resetting', e);
          localStorage.removeItem('vesselConfigCert');
        }
      }

      // --- Default realistic certificates if none in config ---
      let certs = Array.isArray(window.vesselConfigCert.certificatesRequired)
        ? window.vesselConfigCert.certificatesRequired.slice()
        : [
          { name: "Passport", type: "Document", code: "DOC-001", category: "Identity", desc: "Valid passport for international travel.", isRequired: true, requireUpload: true, allowedFileType: 'pdf', maxSizeMB: 10, instructions: "Ensure your passport is valid for at least 6 months from the date of joining." },
          { name: "Seaman’s Book", type: "Document", code: "SBK-101", category: "Identity", desc: "Official seafarer identification booklet.", isRequired: true, requireUpload: true, allowedFileType: 'pdf', maxSizeMB: 5, instructions: "Upload clear scanned pages with personal details and previous contracts." },
          { name: "Basic Safety Training (BST) Certificate", type: "Training", code: "BST-201", category: "Safety", desc: "Mandatory STCW safety training completion.", isRequired: true, requireUpload: true, allowedFileType: 'pdf', maxSizeMB: 5, instructions: "Upload your latest valid BST certificate issued by an accredited training center." },
          { name: "Medical Certificate (Fit for Duty)", type: "Medical", code: "MED-310", category: "Health", desc: "Issued by an approved maritime medical examiner.", isRequired: true, requireUpload: true, allowedFileType: 'pdf', maxSizeMB: 5, instructions: "Submit a scanned copy of your medical certificate, valid for at least 1 year." },
          { name: "Yellow Fever Vaccination", type: "Medical", code: "VAC-111", category: "Health", desc: "International vaccination certificate.", isRequired: false, requireUpload: true, allowedFileType: 'image', maxSizeMB: 3, instructions: "Upload a clear image of the vaccination record (only if required by destination)." },
          { name: "Advanced Fire Fighting (AFF)", type: "Training", code: "AFF-205", category: "Safety", desc: "STCW training for fire emergencies onboard.", isRequired: false, requireUpload: true, allowedFileType: 'pdf', maxSizeMB: 5, instructions: "Only required for officers and crew assigned to emergency duties." }
        ];

      // --- Render functions ---
      function renderCertTable() {
        const $tbody = $('#certTable tbody').empty();
        if (!certs.length) {
          $tbody.append(`<tr><td colspan="8" class="text-muted text-center">No certificates defined</td></tr>`);
          return;
        }
        certs.forEach((c, i) => {
          $tbody.append(objToRow(c, i));
        });
      }

      function objToRow(o, idx) {
        return `
        <tr data-index="${idx}">
          <td>${escapeHtml(o.name)}</td>
          <td><span class="label label-gray">${escapeHtml(o.type || '-')}</span></td>
          <td>${escapeHtml(o.code || '-')}</td>
          <td><span class="label label-light">${escapeHtml(o.category || '-')}</span></td>
          <td>${escapeHtml(o.desc || '-')}</td>
          <td><span class="label ${o.isRequired ? 'label-red' : 'label-gray'}">${o.isRequired ? 'Yes' : 'No'}</span></td>
          <td><span class="label ${o.requireUpload ? 'label-blue' : 'label-gray'}">${o.requireUpload ? 'Yes' : 'No'}</span></td>
          <td>
            <button class="btn btn-xs btn-default edit-cert"><i class="fa fa-pencil"></i></button>
            <button class="btn btn-xs btn-danger delete-cert"><i class="fa fa-trash"></i></button>
          </td>
        </tr>`;
      }

      function escapeHtml(s) {
        if (!s) return '';
        return String(s).replace(/[&<>"']/g, function (m) {
          return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
        });
      }

      // --- Initial render ---
      renderCertTable();
      $('#certInstructions').val(window.vesselConfigCert.certInstructions || '');

      // Add new cert button
      $('#btnAddCert').on('click', function () {
        $('#formCert')[0].reset();
        $('#certRowIndex').val('');
        $('#modalCert').modal('show');
      });

      // Edit cert
      $(document).on('click', '.edit-cert', function () {
        const $tr = $(this).closest('tr');
        const i = parseInt($tr.attr('data-index'), 10);
        const c = certs[i];
        $('#certRowIndex').val(i);
        $('#certName').val(c.name);
        $('#certCategory').val(c.category);
        $('#certType').val(c.type);
        $('#certCode').val(c.code);
        $('#certAllowedFileType').val(c.allowedFileType || 'any');
        $('#certMaxSize').val(c.maxSizeMB || 5);
        $('#certIsRequired').prop('checked', !!c.isRequired);
        $('#certRequireUpload').prop('checked', !!c.requireUpload);
        $('#certDesc').val(c.desc || '');
        $('#certInstructionsPerCert').val(c.instructions || '');
        $('#modalCert').modal('show');
      });

      // Delete cert
      $(document).on('click', '.delete-cert', function () {
        if (!confirm('Delete this certificate template?')) return;
        const $tr = $(this).closest('tr');
        const i = parseInt($tr.attr('data-index'), 10);
        certs.splice(i, 1);
        renderCertTable();
      });

      // Add / update from modal
      $('#formCert').on('submit', function (e) {
        e.preventDefault();
        const idx = $('#certRowIndex').val();
        const o = {
          name: $('#certName').val().trim(),
          category: $('#certCategory').val().trim(),
          type: $('#certType').val().trim(),
          code: $('#certCode').val().trim(),
          allowedFileType: $('#certAllowedFileType').val(),
          maxSizeMB: parseFloat($('#certMaxSize').val()) || 5,
          isRequired: $('#certIsRequired').prop('checked'),
          requireUpload: $('#certRequireUpload').prop('checked'),
          desc: $('#certDesc').val().trim(),
          instructions: $('#certInstructionsPerCert').val().trim()
        };
        if (!o.name) { alert('Please provide a certificate name'); return; }
        if (idx === '') certs.push(o); else certs[parseInt(idx, 10)] = o;
        $('#modalCert').modal('hide');
        renderCertTable();
      });

// Save changes
$('#saveChanges').on('click', function () {
  // Load existing vesselConfigCert safely
  let stored = localStorage.getItem('vesselConfigCert');
  let config = stored ? JSON.parse(stored) : {};

  // Merge certificates
  config.certInstructions = $('#certInstructions').val().trim();
  config.certificatesRequired = certs.slice();

  try {
    localStorage.setItem('vesselConfigCert', JSON.stringify(config));
    showAlert('Certificates configuration saved (demo). Crew portal will be updated shortly!');
  } catch (e) {
    alert('Could not save to localStorage: ' + e);
  }
});

    });
  </script>
  <script>
    //    ShowAlert
    function showAlert(msg, type = 'success') {
      const alert = $(`<div class="alert alert-${type}" style="position:fixed;top:20px;right:20px;z-index:9999;">${msg}</div>`);
      $('body').append(alert);
      setTimeout(() => alert.fadeOut(500, () => alert.remove()), 2000);
    }
  </script>

</body>

</html>