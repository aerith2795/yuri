<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RSI Customer • Dashboard (Enhanced – Vessel-Aware)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Overpass:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/ripple.css">
  <style>
    :root{--r-dark:#0B0F24;--r-gray:#5D7FAC;--r-blue:#3F91FF;--r-red:#E32F31;--r-orange:#FF783F;--r-light:#EFF4FA;--r-green:#2D8548;--r-border:#E6ECF3;--card-shadow:0 2px 6px rgba(7,10,26,.06);--card-shadow-hover:0 2px 10px rgba(7,10,26,.18)}
    html,body{font-family:"Overpass",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#F7F9FC;color:#0B0F24}
    .welcome-banner{background:linear-gradient(90deg,#0B0F24 0%,#10233E 40%,#183054 100%);border-radius:16px;padding:22px 24px;margin-bottom:16px;color:#fff;box-shadow:0 2px 10px rgba(7,10,26,.12)}
    .welcome-banner h2{margin:0 0 4px;font-weight:700}
    .welcome-banner p{margin:0 0 6px;font-size:13px;opacity:.92}
    .breadcrumb-lite{display:flex;gap:8px;align-items:center;margin:0;padding:0;color:#BFD0E8;font-size:12px;list-style:none}
    .breadcrumb-lite li+li:before{content:"/";margin:0 6px;color:#7FA0C9}
    .breadcrumb-lite a{color:#DCE8F7;text-decoration:none}
    .breadcrumb-lite a:hover{text-decoration:underline}
    .top-nav{background:#fff;border:1px solid var(--r-border);border-radius:12px;padding:14px 16px;margin:0 0 16px;box-shadow:var(--card-shadow)}
    .top-nav .title{font-weight:600;margin:4px 0 4px}
    .dashboard-main-row{margin-top:4px}
    .panel{border-radius:14px;border:1px solid var(--r-border);box-shadow:var(--card-shadow);overflow:hidden}
    .panel-heading{background:#fff;border-bottom:1px solid var(--r-border);padding:12px 16px;font-weight:600}
    .panel-heading .sub{font-weight:400;color:#6B84A8;font-size:12px;margin-left:8px}
    .panel-body{background:#fff;padding:12px 16px}
    .list-group-item{border:1px solid var(--r-border);border-radius:8px;margin-bottom:12px !important;display:block;padding-bottom:10px;}
    .empty{padding:12px;border:1px dashed var(--r-border);border-radius:10px;color:#5D7FAC;background:#FBFDFF}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--r-border);margin-right:6px;background:#fff}
    .text-muted-2{color:#6B84A8}
  </style>
</head>
<body>
  <div class="container-fluid dashboard-layout">
    <div class="row">
      <!-- Sidebar placeholder: sidebar HTML will bring its own col-* classes -->
      <div id="sidebar-placeholder"></div>

      <!-- Main content aligned with sidebar -->
      <div class="col-sm-9 col-md-10 main-content">
        <!-- Welcome banner: name + welcome + breadcrumbs only -->
        <div class="row">
          <div class="col-sm-12">
            <div class="welcome-banner">
              <h2 id="user-fullname">Customer Dashboard</h2>
              <p id="welcome-message">Welcome to your Smart Induction customer dashboard.</p>
              <ul class="breadcrumb-lite">
                <li><a href="#">Home</a></li>
                <li>Dashboard</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Vessel selector row -->
        <div class="row">
          <div class="col-sm-12">
            <div class="top-nav" id="vessel-nav">
              <div class="row">
                <div class="col-sm-3">
                  <div class="title">
                    <i class="fa fa-ship text-primary"></i> Working with vessel(s)
                    <i class="fa fa-info-circle text-muted" data-toggle="tooltip" data-placement="top"
                       title="Select one or more vessels to filter data and apply changes only to those vessels."></i>
                  </div>
                  <!-- <p class="text-muted-2">Choose one or more vessels to scope Deletion Requests, Crew Approvals and Incomplete Registrations.</p> -->
                </div>
                <div class="col-sm-9">
                  <div class="row">
                    <div class="col-sm-8">
                      <select class="form-control" id="vessel-select" multiple></select>
                    </div>
                    <div class="col-sm-4 text-right">
                      <button class="btn btn-default btn-sm" id="vs-all">Select All</button>
                      <button class="btn btn-default btn-sm" id="vs-clear">Clear</button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- <div id="vessel-chips" style="margin-top:8px"></div> -->
            </div>
          </div>
        </div>

        <!-- Main dashboard row: left = Action Center + Activity, right = Portal Status -->
        <div class="row dashboard-main-row">
          <div class="col-sm-8">
            <div class="panel panel-default">
              <div class="panel-heading">
                <i class="fa fa-check-square-o text-primary"></i> Action Center
                <span id="ac-scope" class="sub">Scope: All vessels</span>
              </div>
              <div class="panel-body">
                <div class="btn-group" data-toggle="buttons" id="action-tabs">
                  <label class="btn btn-default btn-sm active"><input type="radio" name="ac" value="deletions" checked> Deletion Requests <span class="badge" id="badge-deletions">0</span></label>
                  <label class="btn btn-default btn-sm"><input type="radio" name="ac" value="approvals"> Crew Approvals <span class="badge" id="badge-approvals">0</span></label>
                  <!-- <label class="btn btn-default btn-sm"><input type="radio" name="ac" value="incomplete"> Incomplete Registrations <span class="badge" id="badge-incomplete">0</span></label> -->
                </div>
                <div id="ac-list" class="list-group" style="margin-top:10px"></div>
                <div id="ac-empty" class="empty" style="display:none">No items to review.</div>
              </div>
            </div>

            <div class="panel panel-default">
              <div class="panel-heading"><i class="fa fa-history text-primary"></i> Recent Activity <span class="sub">Latest changes across your portal</span></div>
              <div class="panel-body">
                <ul class="list-group" id="activity-log-list"></ul>
                <div id="activity-empty" class="empty" style="display:none">No recent activity.</div>
              </div>
            </div>
          </div>

          <div class="col-sm-4">
            <div class="panel panel-default">
              <div class="panel-heading"><i class="fa fa-cogs text-primary"></i> Portal Setup Status</div>
              <div class="panel-body">
                <ul class="list-group" id="config-status-list"></ul>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- /.main-content -->
    </div> <!-- /.row -->
  </div> <!-- /.container-fluid -->

  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <script>
  (function(){
    // Load sidebar dynamically and keep layout aligned
    fetch('customer-sidebar.html')
      .then(function(r){ return r.text(); })
      .then(function(html){
        $('#sidebar-placeholder').html(html);
        var activeLink = document.querySelector('[data-page="customer-dashboard"]');
        if(activeLink) activeLink.classList.add('active');
      });

    // ---------- Seed / Persist Datasets ----------
    var vessels = JSON.parse(localStorage.getItem('vessels')||'null') || [
      {id:'VES-001',name:'M/V Ocean Explorer'},
      {id:'VES-002',name:'M/V Yurisan Dozo'},
      {id:'VES-003',name:'M/V Ripple Star'}
    ];
    localStorage.setItem('vessels', JSON.stringify(vessels));

    var deletions = JSON.parse(localStorage.getItem('deletionRequests')||'null') || [
      {id:'DR-1001',vesselId:'VES-001',name:'Carlos Dela Cruz',email:'carlos@sample.com',status:'pending',submitted:Date.now()-86400000},
      {id:'DR-1002',vesselId:'VES-002',name:'Mika Tan',email:'mika@sample.com',status:'pending',submitted:Date.now()-172800000},
      {id:'DR-1003',vesselId:'VES-003',name:'Jonas Pettersen',email:'jonas@sample.com',status:'pending',submitted:Date.now()-3600000}
    ];
    localStorage.setItem('deletionRequests', JSON.stringify(deletions));

    // Applicants (status 'blue' means pending approval)
    var crewApprovals = JSON.parse(localStorage.getItem('crewData')||'null') || [
      {id:'AP-2001',vesselId:'VES-001',name:'Anya Bautista',email:'anya@sample.com',rank:'Deck Cadet',status:'blue'},
      {id:'AP-2002',vesselId:'VES-002',name:'Liam Smith',email:'liam@sample.com',rank:'Chief Officer',status:'blue'},
      {id:'AP-2003',vesselId:'VES-003',name:'Chloe Nguyen',email:'chloe@sample.com',rank:'Stewardess',status:'blue'}
    ];
    localStorage.setItem('crewData', JSON.stringify(crewApprovals));

    var incompleteRegs = JSON.parse(localStorage.getItem('incompleteRegs')||'null') || [
      {id:'IR-3001',vesselId:'VES-001',name:'Kara Ellison',email:'kara@sample.com',meta:'Stopped at Step 3',submitted:Date.now()-259200000},
      {id:'IR-3002',vesselId:'VES-003',name:'Dale Yun',email:'dale@sample.com',meta:'Missing Documents',submitted:Date.now()-86400000}
    ];
    localStorage.setItem('incompleteRegs', JSON.stringify(incompleteRegs));

    var activityLog = JSON.parse(localStorage.getItem('customerActivityLog')||'[]');
    if(activityLog.length===0){
      activityLog = [
        { icon:'fa-user-plus', action:'Accepted applicant <strong>Anya Bautista</strong>.', ts: Date.now()-3*60000 },
        { icon:'fa-shield', action:'Updated <strong>GDPR Policy</strong> content.', ts: Date.now()-2*3600000 },
        { icon:'fa-ship', action:'Added 2 new blocks to <strong>Visual Journey</strong>.', ts: Date.now()-24*3600000 },
        { icon:'fa-paper-plane', action:'Invited 3 new crew members.', ts: Date.now()-3*24*3600000 }
      ];
      localStorage.setItem('customerActivityLog', JSON.stringify(activityLog));
    }

    var activeVessels = JSON.parse(localStorage.getItem('activeVessels')||'[]');

    // ---------- UI helpers ----------
    function formatDateShort(ts){ var d=new Date(ts); return d.toLocaleDateString(); }
    function timeAgo(ts){ var s=Math.floor((Date.now()-ts)/1000),i=s/31536000;if(i>1)return Math.floor(i)+'y';i=s/2592000;if(i>1)return Math.floor(i)+'mo';i=s/86400;if(i>1)return Math.floor(i)+'d';i=s/3600;if(i>1)return Math.floor(i)+'h';i=s/60;if(i>1)return Math.floor(i)+'m';return 'now'; }

    function renderHeader(){
      var p = JSON.parse(localStorage.getItem('userProfile')||'null') || {firstName:'Noctis', lastName:'Caelum'};
      document.getElementById('user-fullname').textContent = p.firstName+" "+p.lastName;
    }

    function populateVesselSelect(){
      var $sel = $('#vessel-select').empty();
      vessels.forEach(function(v){ $sel.append('<option value="'+v.id+'">'+v.name+'</option>'); });
      $sel.select2({placeholder:'Select vessels',width:'100%'});
      if(activeVessels.length){ $sel.val(activeVessels).trigger('change'); }
      renderVesselChips();
      renderScopeText();
    }
    function renderVesselChips(){
      var $chips = $('#vessel-chips').empty();
      var chosen = vessels.filter(function(v){ return activeVessels.indexOf(v.id)>-1; });
      if(!chosen.length){ $chips.append('<span class="text-muted-2">No specific vessel selected (showing all)</span>'); return; }
      chosen.forEach(function(v){ $chips.append('<span class="pill"><i class="fa fa-ship"></i> '+v.name+'</span>'); });
    }
    function renderScopeText(){
      var chosen = vessels.filter(function(v){ return activeVessels.indexOf(v.id)>-1; });
      var names = chosen.map(function(v){return v.name});
      $('#ac-scope').text('Scope: '+(names.length? names.join(', '):'All vessels'));
    }

    // ---------- Data builders ----------
    function getItemsForMode(mode){
      var selected = $('#vessel-select').val()||[];
      var inScope = function(x){ return selected.length===0 || selected.indexOf(x.vesselId)>-1; };
      if(mode==='deletions') return JSON.parse(localStorage.getItem('deletionRequests')||'[]').filter(function(x){return x.status==='pending' && inScope(x)});
      if(mode==='approvals') return JSON.parse(localStorage.getItem('crewData')||'[]').filter(function(x){return x.status==='blue' && inScope(x)});
      if(mode==='incomplete') return JSON.parse(localStorage.getItem('incompleteRegs')||'[]').filter(inScope);
      return [];
    }
    function updateBadges(){
      $('#badge-deletions').text(getItemsForMode('deletions').length);
      $('#badge-approvals').text(getItemsForMode('approvals').length);
      $('#badge-incomplete').text(getItemsForMode('incomplete').length);
    }

    // ---------- Recent Activity ----------
    function renderActivity(){
      var $ul = $('#activity-log-list').empty();
      if(activityLog.length===0){ $('#activity-empty').show(); return; } else { $('#activity-empty').hide(); }
      activityLog.slice(0,10).forEach(function(x){
        $ul.append('<li class="list-group-item"><i class="fa '+x.icon+' text-primary"></i> <span>'+x.action+'</span> <span class="pull-right text-muted-2">'+timeAgo(x.ts)+'</span></li>');
      });
    }

    function pushActivity(icon, actionHtml){
      activityLog.unshift({ icon: icon, action: actionHtml, ts: Date.now() });
      if(activityLog.length > 50){ activityLog = activityLog.slice(0,50); }
      localStorage.setItem('customerActivityLog', JSON.stringify(activityLog));
      renderActivity();
    }

    // ---------- Render list (Action Center) ----------
    function renderList(){
      var mode = $('input[name="ac"]:checked').val();
      var $list = $('#ac-list').empty();
      var items = getItemsForMode(mode);
      if(!items.length){ $('#ac-empty').show(); updateBadges(); return; } else { $('#ac-empty').hide(); }

      items.forEach(function(x){
        var vesselName = (vessels.find(function(v){return v.id===x.vesselId})||{}).name || '';
        var actions='';
        // if(mode==='deletions') actions = '<button class="btn btn-default btn-xs" data-act="approve">Approve</button> <button class="btn btn-default btn-xs" data-act="deny">Deny</button> <button class="btn btn-default btn-xs" data-act="resolve" title="Mark resolved"><i class="fa fa-archive"></i></button>';
        if(mode==='deletions') actions = '<button class="btn btn-default btn-xs" data-act="approve">Approve</button> <button class="btn btn-default btn-xs" data-act="deny">Deny</button>';
        if(mode==='approvals') actions = '<button class="btn btn-default btn-xs" data-act="approve">Approve</button> <button class="btn btn-default btn-xs" data-act="deny">Reject</button>';
        if(mode==='incomplete') actions = '<button class="btn btn-default btn-xs" data-act="nudge">Send Reminder</button>';

        $list.append(
          '<a class="list-group-item" href="#" data-row-id="'+x.id+'" data-mode="'+mode+'">'
          +  '<div class="row">'
          +    '<div class="col-xs-5">'
          +      '<strong class="text-primary">'+x.name+'</strong> <small class="text-muted">'+(x.email||'')+'</small>'
          +      (x.rank? '<br><small class="text-muted">'+x.rank+'</small>':'')
          +    '</div>'
          +    '<div class="col-xs-7 text-right">'
          +      '<span class="text-muted-2">'+(x.submitted? formatDateShort(x.submitted):'')+ (vesselName? ' • '+vesselName:'') +'</span><br>'
          +      '<div class="btn-group" style="margin-top:6px">'+actions+'</div>'
          +    '</div>'
          +  '</div>'
          +'</a>'
        );
      });
      updateBadges();
    }

    // ---------- Portal Setup Status ----------
    function renderConfig(){
      var $list = $('#config-status-list').empty();
      var configs = {
        'Visual Journey': { key:'vesselPageData', check:function(d){return d && d.journey && d.journey.length>0;}, link:'customer-vessel-info.html', value:function(d){return (d && d.journey? d.journey.length:0)+' Blocks';} },
        'Registration Form': { key:'registrationFormConfig_v4', check:function(d){return d && d.sections && d.sections.length>0;}, link:'customer-registration.html', value:function(){return 'Configured';} },
        'GDPR Policy': { key:'gdprConfig', check:function(d){return d && d.policyContent;}, link:'customer-gdpr.html', value:function(){return 'Configured';} },
        'Certificates': { key:'certificatesConfig', check:function(d){return d && d.certificates && d.certificates.length>0;}, link:'customer-certificates.html', value:function(d){return (d && d.certificates? d.certificates.length:0)+' Defined';} },
        'Familiarization Video': { key:'familiarizationConfig', check:function(d){return d && d.videoUrl;}, link:'customer-familiarization.html', value:function(){return 'Video Uploaded';} }
      };

      Object.keys(configs).forEach(function(name){
        var c = configs[name];
        var data = JSON.parse(localStorage.getItem(c.key)||'null');
        var ok = c.check(data);
        var status = ok? '<span class="label label-success">OK</span>' : '<span class="label label-warning">Not Set</span>';
        var val = ok? '<span class="badge">'+c.value(data)+'</span>' : '';
        $list.append('<li class="list-group-item"><a href="'+c.link+'" style="text-decoration:none;color:inherit">'+name+' '+val+' '+status+'</a></li>');
      });
    }

    // ---------- Actions (Approve / Deny / Resolve / Nudge) ----------
    $('#ac-list').on('click','[data-act]', function(e){
      e.preventDefault();
      var $row = $(this).closest('[data-row-id]');
      var id = $row.data('row-id');
      var mode = $row.data('mode');
      var act = $(this).data('act');

      if(mode==='deletions'){
        var arr = JSON.parse(localStorage.getItem('deletionRequests')||'[]');
        var item = arr.find(function(t){return t.id===id});
        if(!item) return;
        if(act==='approve'){ item.status='resolved'; pushActivity('fa-trash','Approved deletion for <strong>'+item.name+'</strong> ('+id+').'); }
        if(act==='deny'){ item.status='denied'; pushActivity('fa-ban','Denied deletion for <strong>'+item.name+'</strong> ('+id+').'); }
        // if(act==='resolve'){ item.status='resolved'; pushActivity('fa-archive','Marked deletion request <strong>'+id+'</strong> as resolved.'); }
        localStorage.setItem('deletionRequests', JSON.stringify(arr));
        renderList();
        return;
      }
      if(mode==='approvals'){
        var ca = JSON.parse(localStorage.getItem('crewData')||'[]');
        var cand = ca.find(function(t){return t.id===id});
        if(!cand) return;
        if(act==='approve'){
          cand.status = 'green';
          pushActivity('fa-check','Approved applicant <strong>'+cand.name+'</strong> ('+id+').');
        } else if(act==='deny'){
          cand.status = 'rejected';
          pushActivity('fa-times','Rejected applicant <strong>'+cand.name+'</strong> ('+id+').');
        }
        localStorage.setItem('crewData', JSON.stringify(ca));
        renderList();
        return;
      }
      if(mode==='incomplete'){
        if(act==='nudge'){
          var inc = JSON.parse(localStorage.getItem('incompleteRegs')||'[]');
          var rec = inc.find(function(t){return t.id===id});
          var name = rec && rec.name ? rec.name : id;
          pushActivity('fa-envelope','Sent reminder for <strong>'+name+'</strong>.');
          console.log('Reminder sent to', id);
        }
        renderList();
      }
    });

    // ---------- Events ----------
    $('#action-tabs input').on('change', function(){ renderList(); });
    $('#vessel-select').on('change', function(){
      activeVessels = $(this).val()||[];
      localStorage.setItem('activeVessels', JSON.stringify(activeVessels));
      renderVesselChips();
      renderScopeText();
      renderList();
    });
    $('#vs-all').on('click', function(){ $('#vessel-select').val(vessels.map(function(v){return v.id})).trigger('change'); });
    $('#vs-clear').on('click', function(){ $('#vessel-select').val(null).trigger('change'); });

    // ---------- Init ----------
    renderHeader();
    populateVesselSelect();
    renderList();
    renderActivity();
    renderConfig();
    $('[data-toggle="tooltip"]').tooltip();

    // ---------- Self-tests (do not remove) ----------
    try{
      console.assert(document.getElementById('user-fullname').textContent.trim().length>0, 'Header name renders');
      console.assert(Array.isArray(vessels) && vessels.length>=3, 'Vessels dataset present');
      console.assert(getItemsForMode('deletions').length>=1, 'Deletions sample present');
      console.assert(getItemsForMode('approvals').length>=1, 'Approvals sample present');
      console.assert(getItemsForMode('incomplete').length>=1, 'Incomplete sample present');
      console.assert($('#badge-deletions').text()==String(getItemsForMode('deletions').length), 'Deletion badge matches');
      console.assert($('#badge-approvals').text()==String(getItemsForMode('approvals').length), 'Approvals badge matches');
      console.assert($('#badge-incomplete').text()==String(getItemsForMode('incomplete').length), 'Incomplete badge matches');
      console.assert(Array.isArray(activityLog) && activityLog.length>=1, 'Activity log seeded');
      console.log('[RSI Dashboard] tests passed');
    }catch(e){ console.error('[RSI Dashboard] tests failed', e); }
  })();
  </script>
</body>
</html>
