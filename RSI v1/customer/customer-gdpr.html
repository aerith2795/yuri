<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>RSI Customer • GDPR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Libs -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

    <!-- Ripple + Admin CSS -->
    <link href="../assets/ripple.css" rel="stylesheet" />
    <link href="page.css" rel="stylesheet" />
    <style>
        .alert-compact {
            padding: 6px 10px;
            margin: 10px 0;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="container-fluid dashboard-layout">
        <div class="row">
            <!-- Sidebar -->
            <div id="sidebar-placeholder"></div>
            <!-- Main -->
            <div class="col-sm-9 col-md-10 main-content">
                <div class="page-header">
                    <h2>GDPR Configuration</h2>
                    <p>Configure the GDPR information that will be shown to crew during registration.</p>
                </div>

                <!-- Alerts -->
                <div id="alertArea"></div>

                <!-- GDPR -->
                <div class="tab-pane" id="gdpr">
                    <div class="panel">
                        <div class="panel-heading">
                            <i class="fa fa-shield"></i> GDPR
                            <button class="btn btn-primary btn-xs pull-right" id="btnAddText">
                                <i class="fa fa-plus"></i> Add Text
                            </button>
                        </div>
                        <div class="panel-body">
                            <table class="table table-bordered" id="gdprTable">
                                <thead>
                                    <tr>
                                        <th style="width: 28%">Title</th>
                                        <th>Body (excerpt)</th>
                                        <th style="width: 16%">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr
                                        data-body="RSI collects and processes personal data including names, contact information, seafarer certificates, and employment history in compliance with the EU General Data Protection Regulation (GDPR). Data is retained only as long as necessary for regulatory compliance and crew management purposes. We employ encryption, secure servers, and strict access controls to ensure data protection. Crew members have the right to request data access, correction, or deletion at any time. For full details, please refer to the official GDPR policy document provided during onboarding.">
                                        <td>General Data Protection Policy</td>
                                        <td>RSI collects and processes personal data including names, contact
                                            information...</td>
                                        <td>
                                            <button class="btn btn-xs btn-default edit-text">
                                                <i class="fa fa-pencil"></i>
                                            </button>
                                            <button class="btn btn-xs btn-danger delete-text">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <div class="form-group">
                                <label>Upload GDPR Document (optional)</label>
                                <input type="file" class="form-control">
                            </div>

                            <hr />
                            <div class="form-group">
                                <label>Page Instructions (shown on Crew GDPR tab)</label>
                                <textarea id="gdprInstructions" class="form-control" rows="3"
                                    placeholder="Provide a quick summary on why GDPR matters and what crew should do."></textarea>
                            </div>
                            <div class="checkbox">
                                <label><input type="checkbox" id="showGdpr"> Show GDPR page</label>
                            </div>
                            <div class="checkbox">
                                <label><input type="checkbox" id="requireAgree"> Include checkbox: “I have read and
                                    agree…”</label>
                            </div>
                            <div class="checkbox">
                                <label><input type="checkbox" id="allowDeletion"> Show Request Profile Deletion
                                    button</label>
                            </div>

                            <hr />
                            <button id="saveGdpr" class="btn btn-primary"><i class="fa fa-save"></i> Save & Post
                                Changes</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Add/Edit GDPR Text -->
        <div class="modal fade" id="modalText">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="formText">
                        <div class="modal-header">
                            <button class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">
                                <i class="fa fa-file-text"></i> GDPR Text
                            </h4>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="textIndex" />
                            <div class="form-group">
                                <label>Title</label>
                                <input id="textTitle" type="text" class="form-control" required />
                            </div>
                            <div class="form-group">
                                <label>Body</label>
                                <textarea id="textBody" class="form-control" rows="8" required></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-default" data-dismiss="modal">
                                Cancel
                            </button>
                            <button class="btn btn-primary" type="submit">
                                <i class="fa fa-save"></i> Save
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>
    

    <script>
        $(function () {
            fetch('customer-sidebar.html')
                .then(r => r.text())
                .then(data => {
                    const sidebarPlaceholder = document.getElementById('sidebar-placeholder');
                    sidebarPlaceholder.innerHTML = data;
                    const currentPage = 'customer-gdpr';
                    const activeLink = sidebarPlaceholder.querySelector(`[data-page="${currentPage}"]`);
                    if (activeLink) activeLink.classList.add('active');
                });

            function showAlert(msg, type = 'success') {
                $("#alertArea").html(
                    `<div class="alert alert-${type} alert-compact"><i class="fa fa-info-circle"></i> ${msg}</div>`
                );
                setTimeout(() => $("#alertArea").empty(), 3000);
            }

            // Long default GDPR text
            const defaultText = `RSI collects and processes personal data including names, contact information, seafarer certificates, and employment history in compliance with the EU General Data Protection Regulation (GDPR). Data is retained only as long as necessary for regulatory compliance and crew management purposes. We employ encryption, secure servers, and strict access controls to ensure data protection. Crew members have the right to request data access, correction, or deletion at any time. For full details, please refer to the official GDPR policy document provided during onboarding.`;

            // Load config (or defaults)
            // Load config (or defaults)
            let gdprConfig = JSON.parse(localStorage.getItem("gdprConfig")) || {
                texts: [
                    { title: "General Data Protection Policy", body: defaultText }
                ],
                showPage: true,
                requireAgree: true,
                allowDeletion: true,
                instructions: "Please review the GDPR policy carefully before proceeding.",
                documentName: "" // <--- add uploaded file name here
            };

            // Save GDPR config
            $("#saveGdpr").on("click", function () {
                gdprConfig.instructions = $("#gdprInstructions").val();
                gdprConfig.showPage = $("#showGdpr").prop("checked");
                gdprConfig.requireAgree = $("#requireAgree").prop("checked");
                gdprConfig.allowDeletion = $("#allowDeletion").prop("checked");

                // handle uploaded file name
                const fileInput = $("input[type='file']")[0];
                if (fileInput.files.length > 0) {
                    gdprConfig.documentName = fileInput.files[0].name;
                }

                localStorage.setItem("gdprConfig", JSON.stringify(gdprConfig));
                showAlert("GDPR configuration posted. Crew portal will be updated shortly!.", "success");
            });

            // Render table (update to also show uploaded file)
            function renderTable() {
                const tbody = $("#gdprTable tbody");
                tbody.empty();
                gdprConfig.texts.forEach((item, i) => {
                    const excerpt = item.body.length > 120 ? item.body.substr(0, 117) + "..." : item.body;
                    tbody.append(`
            <tr data-index="${i}">
                <td>${item.title}</td>
                <td>${excerpt}</td>
                <td>
                    <button class="btn btn-xs btn-default edit-text"><i class="fa fa-pencil"></i></button>
                    <button class="btn btn-xs btn-danger delete-text"><i class="fa fa-trash"></i></button>
                </td>
            </tr>
        `);
                });

                // If document uploaded, show below table
                if (gdprConfig.documentName) {
                    tbody.append(`
            <tr class="active">
                <td colspan="3">
                    <i class="fa fa-file-pdf-o text-danger"></i>
                    Uploaded Document: ${gdprConfig.documentName}
                </td>
            </tr>
        `);
                }
            }
            // Initialize
            renderTable();
            $("#gdprInstructions").val(gdprConfig.instructions);
            $("#showGdpr").prop("checked", gdprConfig.showPage);
            $("#requireAgree").prop("checked", gdprConfig.requireAgree);
            $("#allowDeletion").prop("checked", gdprConfig.allowDeletion);

            // Save GDPR config
            $("#saveGdpr").on("click", function () {
                gdprConfig.instructions = $("#gdprInstructions").val();
                gdprConfig.showPage = $("#showGdpr").prop("checked");
                gdprConfig.requireAgree = $("#requireAgree").prop("checked");
                gdprConfig.allowDeletion = $("#allowDeletion").prop("checked");

                localStorage.setItem("gdprConfig", JSON.stringify(gdprConfig));
                // showAlert("GDPR configuration saved. Crew portal will reflect these settings.", "success");
            });

            // Add new GDPR text
            $("#btnAddText").on("click", function () {
                $("#textIndex").val("");
                $("#textTitle").val("");
                $("#textBody").val("");
                $("#modalText").modal("show");
            });

            // Edit
            $(document).on("click", ".edit-text", function () {
                const i = $(this).closest("tr").data("index");
                $("#textIndex").val(i);
                $("#textTitle").val(gdprConfig.texts[i].title);
                $("#textBody").val(gdprConfig.texts[i].body);
                $("#modalText").modal("show");
            });

            // Delete
            $(document).on("click", ".delete-text", function () {
                const i = $(this).closest("tr").data("index");
                if (confirm("Delete this GDPR text?")) {
                    gdprConfig.texts.splice(i, 1);
                    renderTable();
                }
            });

            // Save modal form
            $("#formText").on("submit", function (e) {
                e.preventDefault();
                const idx = $("#textIndex").val();
                const t = $("#textTitle").val(), b = $("#textBody").val();

                if (idx === "") gdprConfig.texts.push({ title: t, body: b });
                else gdprConfig.texts[parseInt(idx, 10)] = { title: t, body: b };

                renderTable();
                $("#modalText").modal("hide");
                showAlert('GDPR info saved!', 'success');

            });

            //    ShowAlert
            function showAlert(msg, type = 'success') {
                const alert = $(`<div class="alert alert-${type}" style="position:fixed;top:20px;right:20px;z-index:9999;">${msg}</div>`);
                $('body').append(alert);
                setTimeout(() => alert.fadeOut(500, () => alert.remove()), 2000);
            }
        });
    </script>


</body>

</html>