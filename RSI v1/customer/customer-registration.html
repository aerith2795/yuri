<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>RSI Customer â€¢ Registration Config</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <link href="../assets/ripple.css" rel="stylesheet" />
    <link href="page.css" rel="stylesheet" />
    <style>
        body {
            padding-bottom: 80px;
        }

        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f5f5f5;
            border-top: 1px solid #ddd;
            padding: 10px 0;
            z-index: 1000;
        }

        .footer-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Edit Mode Styles */
        .edit-mode .section-panel {
            border: 1px dashed #ccc;
            background-color: #fcfcfc;
            padding: 10px;
            margin-bottom: 15px;
        }

        .edit-mode .section-panel .panel-heading {
            cursor: grab;
            padding-left: 0;
            padding-right: 0;
            background-color: transparent;
            border-bottom: none;
        }

        .edit-mode .section-panel .panel-title-text {
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 10px;
            display: block;
        }

        .edit-mode .section-panel .panel-heading .btn,
        .edit-mode .field-item .btn-group .btn {
            display: inline-block !important;
        }

        .edit-mode .field-item {
            border: 1px dashed #eee;
            background-color: #fff;
            margin-bottom: 5px;
            cursor: grab;
        }

        .edit-mode .field-item:hover {
            background-color: #f5f5f5;
        }

        .edit-mode .field-item .field-info {
            flex-grow: 1;
            padding-left: 10px;
        }

        .edit-mode .drag-handle {
            cursor: grab;
            color: #aaa;
            margin-right: 10px;
        }

        .edit-mode .field-config-label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        /* Preview Mode Styles */
        .preview-mode .section-panel {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .preview-mode .section-panel .panel-heading {
            background-color: var(--r-light);
            color: var(--r-dark);
            font-weight: 600;
            border-color: #eee;
            border-radius: 3px 3px 0 0;
        }

        .preview-mode .section-panel .panel-body {
            padding: 15px;
        }

        .preview-mode .form-group {
            margin-bottom: 15px;
        }

        .preview-mode .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        .preview-mode .form-group .required-field::after {
            content: " *";
            color: var(--r-red);
        }

        .preview-mode .form-group input,
        .preview-mode .form-group select,
        .preview-mode .form-group textarea {
            background-color: #f9f9f9;
            cursor: default;
        }

        /* Appearance for preview */
        .preview-mode .edit-mode-item,
        .preview-mode .drag-handle,
        .preview-mode .btn-edit-section-title,
        .preview-mode .field-item .field-actions {
            display: none !important;
        }

        /* General styles for field items */
        .field-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
        }

        .field-item .field-info {
            flex-grow: 1;
        }

        .field-item .field-actions {
            margin-left: auto;
        }

        .field-item .field-actions .btn {
            margin-left: 5px;
        }

        #generalInstructionsDisplay {
            border: 1px dashed #ddd;
            padding: 15px;
            background-color: #fcfcfc;
            margin-bottom: 20px;
            font-style: italic;
            color: #555;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <div class="container-fluid dashboard-layout">
        <div class="row">
            <div id="sidebar-placeholder"></div>
            <div class="col-sm-9 col-md-10 main-content">
                <div class="page-header">
                    <h2>Registration Form Configuration</h2>
                    <p>Build the crew registration form by adding custom sections and fields. Preview below to see the
                        crew experience.</p>
                </div>

                <div class="panel panel-default">
                    <div class="panel-body">
                        <div class="alert alert-info" style="margin-bottom:0;">
                            <i class="fa fa-lock"></i> <strong>Locked Fields:</strong> The following fields are
                            mandatory and always included:
                            <br> First Name, Surname, Gender, Date of Birth, Company, Position/Rank, Email, Password.
                        </div>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div class="panel-heading"><i class="fa fa-info-circle"></i> General Instructions for Crew</div>
                    <div class="panel-body">
                        <textarea class="form-control edit-mode-item" id="generalInstructions" rows="3"
                            placeholder="e.g., Please prepare scanned copies of your documents before starting."></textarea>
                        <div id="generalInstructionsDisplay" class="preview-mode-item"></div>
                    </div>
                </div>

                <div id="form-builder-container">
                </div>

                <div id="add-section-controls" class="edit-mode-item">
                    <button class="btn btn-default" id="btnAddCustomSection"><i class="fa fa-plus"></i> Add Custom
                        Section</button>
                    <button class="btn btn-default" id="btnAddNokSection"><i class="fa fa-users"></i> Add Next of Kin
                        Section</button>
                </div>
            </div>
        </div>
    </div>

    <div class="sticky-footer">
        <div class="footer-container" id="footer-btn-container"></div>
    </div>

    <div class="modal fade" id="addEditSectionModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="sectionModalTitle">Add Custom Section</h4>
                </div>
                <div class="modal-body"><input type="hidden" id="editSectionId">
                    <div class="form-group"><label>Section Title</label><input type="text" id="sectionTitleInput"
                            class="form-control" placeholder="e.g., Personal Details"></div>
                </div>
                <div class="modal-footer"><button class="btn btn-default" data-dismiss="modal">Cancel</button><button
                        class="btn btn-primary" id="saveSectionBtn">Save Section</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addFieldModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="formField">
                    <div class="modal-header">
                        <h4 class="modal-title" id="fieldModalTitle">Add Field</h4>
                    </div>
                    <div class="modal-body"><input type="hidden" id="fieldSectionId"><input type="hidden"
                            id="fieldUniqueId">
                        <div class="form-group" id="fieldLabelGroup"><label>Field Label</label><input type="text"
                                class="form-control" id="fldLabel" required /></div>
                        <div class="form-group"><label>Field Type</label><select id="fldType" class="form-control">
                                <option value="text">Text Input</option>
                                <option value="date">Date Input</option>
                                <option value="email">Email Input</option>
                                <option value="select">Dropdown Selection</option>
                                <option value="file">File Upload</option>
                                <option value="textarea">Large Text Area</option>
                            </select></div>
                        <div class="row">
                            <div class="col-sm-6"><label>Visible</label><select id="fldVisible" class="form-control">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select></div>
                            <div class="col-sm-6"><label>Required</label><select id="fldRequired" class="form-control">
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select></div>
                        </div>
                        <div class="form-group" style="margin-top:10px;"><label>Validation / Notes</label><input
                                type="text" class="form-control" id="fldValidation"
                                placeholder="e.g., Max 5MB, PDF/JPG only; List options for dropdown" /></div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-default"
                            data-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary"><i
                                class="fa fa-save"></i> Save Field</button></div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script>
        $(function () {
            // --- INITIALIZATION & DATA ---
            fetch('customer-sidebar.html')
                .then(response => response.text())
                .then(data => {
                    const sidebarPlaceholder = document.getElementById('sidebar-placeholder');
                    sidebarPlaceholder.innerHTML = data;

                    // Script to set the active state after the sidebar is loaded
                    const currentPage = 'customer-registration';
                    const activeLink = sidebarPlaceholder.querySelector(`[data-page="${currentPage}"]`);
                    if (activeLink) {
                        activeLink.classList.add('active');
                    }
                })
                .catch(error => console.error('Error fetching sidebar:', error)); $('.select2').select2({ dropdownParent: $('#addFieldModal') }); // Initialize select2

            const configKey = "registrationFormConfig";
            let formConfig = []; // Stores the current configuration of sections and fields

            // Pre-defined template for NOK fields
            const nokFieldTemplates = [
                { id: 'nok_rel', label: 'Relationship', type: 'select', visible: true, required: true, validation: 'Spouse, Parent, Sibling, Other' },
                { id: 'nok_fname', label: 'First Name', type: 'text', visible: true, required: true, validation: '' },
                { id: 'nok_lname', label: 'Surname', type: 'text', visible: true, required: true, validation: '' },
                { id: 'nok_address', label: 'Address', type: 'text', visible: true, required: false, validation: '' },
                { id: 'nok_residence', label: 'Residence', type: 'select', visible: true, required: false, validation: 'Philippines, Norway, Greece' }, // Example options
                { id: 'nok_phone', label: 'Phone', type: 'text', visible: true, required: false, validation: '' },
                { id: 'nok_mobile', label: 'Mobile', type: 'text', visible: true, required: false, validation: '' },
                { id: 'nok_email', label: 'Email', type: 'email', visible: false, required: false, validation: '' }
            ];

            // --- CORE FUNCTIONS ---
            function generateUniqueId(prefix = 'id_') { return prefix + Date.now() + Math.floor(Math.random() * 1000); }

            function toggleViewMode(isEditing) {
                $('body').toggleClass('edit-mode', isEditing).toggleClass('preview-mode', !isEditing);
                $('.edit-mode-item').toggle(isEditing);
                $('.preview-mode-item').toggle(!isEditing);

                // Re-initialize Sortable for sections and fields based on mode
                if (isEditing) {
                    initSortableSections();
                    $('.section-panel').each(function () {
                        initSortableFields($(this).find('.field-list')[0]);
                    });
                } else {
                    // Destroy sortable instances in preview mode
                    if ($('#form-builder-container')[0].sortable) $('#form-builder-container')[0].sortable.destroy();
                    $('.section-panel').each(function () {
                        if ($(this).find('.field-list')[0].sortable) $(this).find('.field-list')[0].sortable.destroy();
                    });
                }

                if (isEditing) {
                    $('#footer-btn-container').html('<button id="saveBtn" class="btn btn-success btn-block"><i class="fa fa-save"></i> Save Configuration</button>');
                } else {
                    $('#footer-btn-container').html('<button id="editBtn" class="btn btn-primary btn-block"><i class="fa fa-pencil"></i> Edit Configuration</button>');
                }
            }

            function saveConfig() {
                // Update formConfig with current DOM order and values
                const newConfig = [];
                $('#form-builder-container .section-panel').each(function () {
                    const sectionId = $(this).data('id');
                    let section = formConfig.find(s => s.id === sectionId);

                    if (!section) return; // Should not happen

                    // Update section title from DOM (if editable)
                    if (section.type === 'custom') {
                        section.title = $(this).find('.section-title-text').text().trim();
                    }

                    const newFields = [];
                    $(this).find('.field-item').each(function () {
                        const fieldUniqueId = $(this).data('unique-id');
                        const field = section.fields.find(f => f.uniqueId === fieldUniqueId);
                        if (field) newFields.push(field);
                    });
                    section.fields = newFields;
                    newConfig.push(section);
                });
                formConfig = newConfig;

                localStorage.setItem(configKey, JSON.stringify({
                    instructions: $('#generalInstructions').val(),
                    sections: formConfig
                }));
                alert("Configuration saved!");
                renderFormBuilder(); // Re-render to show updated preview
                toggleViewMode(false);
            }

            function loadConfig() {
                const savedConfig = JSON.parse(localStorage.getItem(configKey));
                if (savedConfig) {
                    $('#generalInstructions').val(savedConfig.instructions || "");
                    formConfig = savedConfig.sections || [];
                    return true;
                } else {
                    // Default config with some example data
                    formConfig = [
                        {
                            id: generateUniqueId('sec'), title: 'Personal Details', type: 'custom', fields: [
                                { uniqueId: generateUniqueId('fld'), id: 'address', label: 'Residence Address', type: 'text', visible: true, required: true, validation: '' },
                                { uniqueId: generateUniqueId('fld'), id: 'mobile', label: 'Mobile Number', type: 'text', visible: true, required: true, validation: '' }
                            ]
                        },
                        {
                            id: generateUniqueId('sec'), title: 'Company Information', type: 'custom', fields: [
                                { uniqueId: generateUniqueId('fld'), id: 'passport', label: 'Passport Upload', type: 'file', visible: true, required: true, validation: 'PDF/JPG/PNG only, Max 5MB' },
                                { uniqueId: generateUniqueId('fld'), id: 'emergencyContact', label: 'Company Emergency Contact', type: 'text', visible: true, required: false, validation: '' }
                            ]
                        },
                        { id: generateUniqueId('sec'), title: 'Next of Kin 1', type: 'nok', fields: JSON.parse(JSON.stringify(nokFieldTemplates)).map(f => ({ ...f, uniqueId: generateUniqueId('fld') })) }
                    ];
                    $('#generalInstructions').val("Welcome to the crew registration. Please provide accurate details below.");
                    return false;
                }
            }

            function renderFormBuilder() {
                const container = $('#form-builder-container').empty();
                $('#generalInstructionsDisplay').html($('#generalInstructions').val() ? `<p>${$('#generalInstructions').val()}</p>` : `<p class="text-muted">No general instructions set.</p>`);


                formConfig.forEach(section => {
                    // Section actions
                    const sectionActions = `
                        <div class="pull-right btn-group edit-mode-item">
                            <button class="btn btn-default btn-xs btn-edit-section-title"><i class="fa fa-pencil"></i></button>
                            ${section.type === 'custom' ? `<button class="btn btn-primary btn-xs btn-add-field"><i class="fa fa-plus"></i> Add Field</button>` : ''}
                            <button class="btn btn-danger btn-xs btn-delete-section"><i class="fa fa-trash"></i></button>
                        </div>`;

                    // Section Title (editable in edit mode)
                    const sectionTitleContent = `
                        <span class="drag-handle edit-mode-item"><i class="fa fa-bars"></i></span>
                        <strong class="section-title-text" style="cursor:pointer;">${section.title}</strong>
                        `;

                    const panel = $(`
                        <div class="panel panel-default section-panel" data-id="${section.id}">
                            <div class="panel-heading">
                                ${sectionTitleContent}
                                ${sectionActions}
                            </div>
                            <div class="panel-body">
                                <ul class="field-list"></ul>
                            </div>
                        </div>`).appendTo(container);

                    const fieldList = panel.find('.field-list');
                    section.fields.forEach(field => {
                        if (!field.visible && !$('body').hasClass('edit-mode')) {
                            return; // Skip hidden fields in preview mode
                        }
                        const requiredClass = field.required ? 'required-field' : '';
                        const labelContent = `<label class="${requiredClass}">${field.label}</label>`;
                        const inputPlaceholder = field.validation || ''; // Use validation as placeholder in preview

                        let inputElement;
                        switch (field.type) {
                            case 'text':
                                inputElement = `<input type="text" class="form-control" value="${field.label} Example" placeholder="${inputPlaceholder}" disabled>`;
                                break;
                            case 'date':
                                inputElement = `<input type="date" class="form-control" value="2023-01-01" disabled>`;
                                break;
                            case 'email':
                                inputElement = `<input type="email" class="form-control" value="example@example.com" placeholder="${inputPlaceholder}" disabled>`;
                                break;
                            case 'select':
                                const options = field.validation.split(',').map(opt => `<option>${opt.trim()}</option>`).join('');
                                inputElement = `<select class="form-control" disabled><option>${field.label} Option</option>${options}</select>`;
                                break;
                            case 'file':
                                inputElement = `<input type="file" class="form-control" disabled>`;
                                break;
                            case 'textarea':
                                inputElement = `<textarea class="form-control" rows="3" placeholder="${inputPlaceholder}" disabled>${field.label} Example Text</textarea>`;
                                break;
                            default:
                                inputElement = `<input type="text" class="form-control" value="${field.label} Value" placeholder="${inputPlaceholder}" disabled>`;
                        }

                        // Field actions for edit mode
                        const fieldActions = `
                            <div class="btn-group field-actions edit-mode-item">
                                <button class="btn btn-default btn-xs btn-edit-field"><i class="fa fa-pencil"></i></button>
                                <button class="btn btn-danger btn-xs btn-delete-field"><i class="fa fa-trash"></i></button>
                            </div>`;

                        const fieldItem = $(`
                            <li class="field-item" data-unique-id="${field.uniqueId}" data-field-id="${field.id}">
                                <span class="drag-handle edit-mode-item"><i class="fa fa-bars"></i></span>
                                <div class="field-info">
                                    <span class="edit-mode-item field-config-label">${field.label} <small class="text-muted">(${field.type}) - ${field.visible ? 'Visible' : 'Hidden'}, ${field.required ? 'Required' : 'Optional'}</small></span>
                                    <div class="form-group preview-mode-item" style="margin-bottom:0;">
                                        ${labelContent}
                                        ${inputElement}
                                        ${field.validation ? `<p class="help-block"><small>${field.validation}</small></p>` : ''}
                                    </div>
                                </div>
                                ${fieldActions}
                            </li>`);
                        fieldList.append(fieldItem);
                    });
                    // Show message if no visible fields in preview mode
                    if (section.fields.filter(f => f.visible).length === 0 && $('body').hasClass('preview-mode')) {
                        fieldList.html(`<li class="field-item text-muted">No fields visible in this section.</li>`);
                    } else if (section.fields.length === 0 && $('body').hasClass('edit-mode')) {
                        fieldList.html(`<li class="field-item text-muted">No fields in this section. Click "Add Field" to add one.</li>`);
                    }
                });
                toggleViewMode($('body').hasClass('edit-mode')); // Re-apply visibility and sortable after render
            }

            function initSortableSections() {
                new Sortable($('#form-builder-container')[0], {
                    handle: '.panel-heading',
                    animation: 150,
                    onEnd: function (evt) {
                        const movedItem = formConfig.splice(evt.oldIndex, 1)[0];
                        formConfig.splice(evt.newIndex, 0, movedItem);
                    }
                });
            }

            function initSortableFields(element) {
                new Sortable(element, {
                    handle: '.drag-handle',
                    animation: 150,
                    onEnd: function (evt) {
                        const sectionId = $(evt.from).closest('.section-panel').data('id');
                        const section = formConfig.find(s => s.id === sectionId);
                        if (section) {
                            const movedItem = section.fields.splice(evt.oldIndex, 1)[0];
                            section.fields.splice(evt.newIndex, 0, movedItem);
                        }
                    }
                });
            }

            // --- EVENT HANDLERS ---
            $('#footer-btn-container').on('click', '#saveBtn', saveConfig);
            $('#footer-btn-container').on('click', '#editBtn', () => toggleViewMode(true));

            // Add/Edit Section Modals
            $('#btnAddCustomSection').on('click', () => {
                $('#sectionModalTitle').text('Add Custom Section');
                $('#newSectionTitle').val('');
                $('#editSectionId').val('');
                $('#addEditSectionModal').modal('show');
            });
            $('#btnAddNokSection').on('click', function () {
                const nokSections = formConfig.filter(s => s.type === 'nok');
                const newNokTitle = `Next of Kin ${nokSections.length + 1}`;
                const newNokId = generateUniqueId('sec_nok');

                // Deep copy NOK field templates and assign uniqueIds
                const fieldsForNok = nokFieldTemplates.map(f => ({ ...f, uniqueId: generateUniqueId('fld') }));

                formConfig.push({ id: newNokId, title: newNokTitle, type: 'nok', fields: fieldsForNok });
                renderFormBuilder();
                toggleViewMode(true);
            });

            $('#saveSectionBtn').on('click', function () {
                const title = $('#sectionTitleInput').val().trim();
                const sectionId = $('#editSectionId').val();
                if (title) {
                    if (sectionId) { // Editing existing section
                        const section = formConfig.find(s => s.id === sectionId);
                        if (section) section.title = title;
                    } else { // Adding new section
                        formConfig.push({ id: generateUniqueId('sec'), title: title, type: 'custom', fields: [] });
                    }
                    renderFormBuilder();
                    toggleViewMode(true);
                }
                $('#addEditSectionModal').modal('hide');
            });
            $('#form-builder-container').on('click', '.btn-edit-section-title, .section-title-text', function () {
                const sectionPanel = $(this).closest('.section-panel');
                const sectionId = sectionPanel.data('id');
                const section = formConfig.find(s => s.id === sectionId);
                if (section.type === 'custom') { // Only custom sections can have titles edited
                    $('#sectionModalTitle').text('Edit Section Title');
                    $('#sectionTitleInput').val(section.title);
                    $('#editSectionId').val(sectionId);
                    $('#addEditSectionModal').modal('show');
                }
            });

            $('#form-builder-container').on('click', '.btn-delete-section', function () {
                const sectionId = $(this).closest('.section-panel').data('id');
                if (confirm('Are you sure you want to delete this entire section and all its fields?')) {
                    formConfig = formConfig.filter(s => s.id !== sectionId);
                    renderFormBuilder();
                    toggleViewMode(true);
                }
            });

            // Add/Edit Field Modals
            $('#form-builder-container').on('click', '.btn-add-field', function () {
                const sectionId = $(this).closest('.section-panel').data('id');
                $('#formField')[0].reset();
                $('#fieldSectionId').val(sectionId);
                $('#fieldUniqueId').val(''); // Clear for new field
                $('#fieldModalTitle').text('Add Field');
                // Enable all fields for custom section add
                $('#fldLabel, #fldType').prop('disabled', false);
                $('#fieldLabelGroup').show(); // Ensure label input is visible for custom fields
                $('#addFieldModal').modal('show');
            });

            $('#form-builder-container').on('click', '.btn-edit-field', function () {
                const sectionId = $(this).closest('.section-panel').data('id');
                const fieldUniqueId = $(this).closest('.field-item').data('unique-id');
                const section = formConfig.find(s => s.id === sectionId);
                const field = section.fields.find(f => f.uniqueId === fieldUniqueId);

                if (field) {
                    $('#fieldSectionId').val(sectionId);
                    $('#fieldUniqueId').val(fieldUniqueId);
                    $('#fldLabel').val(field.label);
                    $('#fldType').val(field.type);
                    $('#fldVisible').val(field.visible.toString());
                    $('#fldRequired').val(field.required.toString());
                    $('#fldValidation').val(field.validation);

                    $('#fieldModalTitle').text('Edit Field');

                    // Disable Label and Type for NOK fields
                    const isNokField = section.type === 'nok';
                    $('#fldLabel, #fldType').prop('disabled', isNokField);
                    $('#fieldLabelGroup').toggle(!isNokField); // Hide label input if NOK field

                    $('#addFieldModal').modal('show');
                }
            });

            $('#formField').on('submit', function (e) {
                e.preventDefault();
                const sectionId = $('#fieldSectionId').val();
                const fieldUniqueId = $('#fieldUniqueId').val(); // For editing an existing field
                const section = formConfig.find(s => s.id === sectionId);

                if (!section) return;

                const isNokField = section.type === 'nok';
                const fieldLabel = isNokField ? $('#fldLabel').val() : $('#fldLabel').val(); // Label is read-only for NOK, but we still need its value

                const fieldData = {
                    label: fieldLabel,
                    type: $('#fldType').val(),
                    visible: $('#fldVisible').val() === 'true',
                    required: $('#fldRequired').val() === 'true',
                    validation: $('#fldValidation').val()
                };

                if (fieldUniqueId) { // Editing existing field
                    const field = section.fields.find(f => f.uniqueId === fieldUniqueId);
                    if (field) Object.assign(field, fieldData);
                } else { // Adding new field to a custom section
                    fieldData.uniqueId = generateUniqueId('fld');
                    // For custom sections, we don't need a predefined 'id' for the field, uniqueId is enough
                    fieldData.id = fieldData.label.toLowerCase().replace(/\s/g, '_'); // Generate a simple ID for custom fields
                    section.fields.push(fieldData);
                }
                renderFormBuilder();
                toggleViewMode(true);
                $('#addFieldModal').modal('hide');
            });

            $('#form-builder-container').on('click', '.btn-delete-field', function () {
                const sectionId = $(this).closest('.section-panel').data('id');
                const fieldUniqueId = $(this).closest('.field-item').data('unique-id');
                if (confirm('Are you sure you want to delete this field?')) {
                    const section = formConfig.find(s => s.id === sectionId);
                    if (section) {
                        section.fields = section.fields.filter(f => f.uniqueId !== fieldUniqueId);
                        renderFormBuilder();
                        toggleViewMode(true);
                    }
                }
            });

            // --- INITIAL LOAD ---
            const hasData = loadConfig();
            renderFormBuilder();
            toggleViewMode(!hasData); // Start in preview mode if data exists, else edit mode for initial setup
        });
    </script>
</body>

</html>