<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>RSI Client • Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Libs -->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

  <!-- Ripple core + Page CSS -->
  <link href="../assets/ripple.css" rel="stylesheet" />
  <link href="page.css" rel="stylesheet" />

</head>

<body>
  <button type="button" id="sidebar-toggle" class="mobile-toggle">
    <i class="fa fa-bars"></i>
  </button>
  <div class="container-fluid dashboard-layout">
    <div class="row">
      <!-- Sidebar -->
      <div id="sidebar-placeholder" class="col-sm-3 col-md-2 sidebar"></div>

      <!-- Main -->
      <div class="col-sm-9 col-md-10 main-content">

        <!-- Onboarding Progress -->
        <div class="progress-container">
          <div class="clearfix">
            <span class="pull-left"><strong>Onboarding Progress</strong></span>
            <span class="pull-right" id="progressText">0 of 4 tasks completed</span>
          </div>
          <div class="progress progress-with-steps">
            <div id="progressBar" class="progress-bar progress-bar-striped active" role="progressbar"
              style="width: 0%;"></div>
            <div class="progress-steps">
              <span class="step" style="left: 0%;">Embarkation</span>
              <span class="step" style="left: 33%;">Certificates</span>
              <span class="step" style="left: 66%;">GDPR</span>
              <span class="step" style="left: 100%;">Video</span>
            </div>
          </div>
        </div>

        <!-- Welcome + Alerts -->
        <div class="tab-pane active" id="welcome">
          <div class="page-header">
            <h2>Hi, Cloud Strife!</h2>
            <p>Welcome to MV Yuri Smart Induction. Your registration is complete. To continue, please complete your
              onboarding tasks below.</p>
          </div>

          <!-- Next Voyage -->
          <div class="panel panel-default voyage-panel">
            <div class="panel-heading">
              <h4 class="panel-title"><i class="fa fa-calendar"></i> Your Embarkation Details</h4>
            </div>
            <div class="panel-body">
              <div class="voyage-details">
                <div><strong>Date</strong> <span id="embarkDateDisplay">—</span></div>
                <div><strong>Time</strong> <span id="embarkTimeDisplay">—</span></div>
                <div><strong>Location</strong> <span id="embarkLocationDisplay">—</span></div>
              </div>
            </div>
            <div class="text-right" style="margin-top:10px;">
              <a href="crew-vessel-info.html" class="btn btn-default btn-block">
                <i class="fa fa-ship"></i> Explore M/V Yurisan Dozo
              </a>
            </div>
          </div>

          <!-- Alerts Panel -->
          <div class="row" id="alertsRow">
            <div class="panel alerts-panel">
              <div class="panel-heading"><i class="fa fa-bell"></i> Alerts</div>
              <div class="panel-body">
                <div id="reminders">
                  <!-- <div class="alert alert-info" id="embarkReminder">
                    <span><i class="fa fa-info-circle"></i> Fill out your embarkation details.</span>
                    <button class="btn btn-xs btn-primary complete-task" data-task="embark">Go</button>
                  </div> -->
                  <div class="alert alert-warning" id="certReminder">
                    <span><i class="fa fa-upload"></i> Upload your certificates.</span>
                    <button class="btn btn-xs btn-primary complete-task" data-task="cert">Upload</button>
                  </div>
                  <div class="alert alert-info" id="gdprReminder">
                    <span><i class="fa fa-shield"></i> Review GDPR.</span>
                    <button class="btn btn-xs btn-primary complete-task" data-task="gdpr">Review</button>
                  </div>
                  <div class="alert alert-success" id="videoReminder">
                    <span><i class="fa fa-video-camera"></i> Watch familiarization video.</span>
                    <button class="btn btn-xs btn-primary complete-task" data-task="video">Watch</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Activity Logs -->
          <div class="panel">
            <div class="panel-heading"><i class="fa fa-history"></i> Activity Logs / History</div>
            <div class="panel-body">
              <table class="table table-bordered" id="crewLogsTable">
                <thead>
                  <tr></tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="5" class="text-center text-muted">No logs available</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </div><!-- /main -->
    </div>
  </div>

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

  <script>
    function showAlert(msg, type = 'success') {
      const alert = $(`<div class="alert alert-${type}" style="position:fixed;top:20px;right:20px;z-index:9999;">${msg}</div>`);
      $('body').append(alert);
      setTimeout(() => alert.fadeOut(500, () => alert.remove()), 2000);
    }

    // Utility: log crew activity
    function logCrewActivity(activity, remarks = '') {
      const stored = localStorage.getItem("vesselConfig");
      let config = stored ? JSON.parse(stored) : { logs: {} };

      if (!config.logs) config.logs = {};
      if (!config.logs.entries) config.logs.entries = [];

      // Default columns (fallback)
      const cols = config.logs.columns || ["Date", "Activity", "Remarks"];

      // Build row object
      const now = new Date();
      const row = {};
      cols.forEach(c => {
        if (c.toLowerCase() === "date") row[c] = now.toLocaleString();
        else if (c.toLowerCase() === "activity") row[c] = activity;
        else if (c.toLowerCase() === "remarks") row[c] = remarks;
        else row[c] = "—";
      });

      // Add new log to top
      config.logs.entries.unshift(row);

      // Keep only max `count`
      if (config.logs.count && config.logs.entries.length > config.logs.count) {
        config.logs.entries = config.logs.entries.slice(0, config.logs.count);
      }

      localStorage.setItem("vesselConfig", JSON.stringify(config));
      renderCrewLogs(config.logs);
    }

    // Load vesselConfig
    const stored = localStorage.getItem("vesselConfig");
    const config = stored ? JSON.parse(stored) : {};
    if (config.embarkation) {
      $('#embarkDateDisplay').text(config.embarkation.date || '—');
      $('#embarkTimeDisplay').text(config.embarkation.time || '—');
      $('#embarkLocationDisplay').text(config.embarkation.location || '—');
    }

    // Render Activity Logs
    function renderCrewLogs(logsConfig) {
      const cols = (logsConfig && logsConfig.columns) || [];
      const entries = (logsConfig && logsConfig.entries) || [];
      const count = (logsConfig && logsConfig.count) || 0;

      const headerRow = $('#crewLogsTable thead tr').empty();
      const tbody = $('#crewLogsTable tbody').empty();

      if (cols.length && (entries.length || count > 0)) {
        cols.forEach(c => headerRow.append(`<th>${c}</th>`));

        if (entries.length) {
          // Show saved (real) entries
          entries.forEach(row => {
            let tr = '<tr>';
            cols.forEach(c => tr += `<td>${row[c] || '—'}</td>`);
            tr += '</tr>';
            tbody.append(tr);
          });
        } else {
          // Fallback: demo/sample rows
          for (let i = 0; i < count; i++) {
            let tr = '<tr>';
            cols.forEach(c => tr += `<td>${c} sample ${i + 1}</td>`);
            tr += '</tr>';
            tbody.append(tr);
          }
        }
      } else {
        tbody.html('<tr><td colspan="5" class="text-center text-muted">No logs available</td></tr>');
      }
    }

    $(function () {
 $('#sidebar-toggle').on('click', function () {
        $('.sidebar').toggleClass('active');
      });
      // Load sidebar
      fetch('crew-sidebar.html')
        .then(r => r.text())
        .then(data => {
          $('#sidebar-placeholder').html(data);
          $('[data-page="crew-dashboard"]').addClass('active');
        });

      // Load vessel info
      const stored = localStorage.getItem("vesselConfig");
      let config = stored ? JSON.parse(stored) : { aboutVessel: '', photos: [] };

      // Render activity logs from config
      renderCrewLogs(config.logs);

      // Onboarding tasks
      const tasks = ['cert', 'gdpr', 'video'];
      let progress = JSON.parse(localStorage.getItem("progress")) || {};

      function saveProgress() {
        localStorage.setItem("progress", JSON.stringify(progress));
      }

      function updateProgress() {
        const completed = tasks.filter(t => progress[t]).length;
        $('#progressBar').css('width', (completed / tasks.length * 100) + '%');
        $('#progressText').text(`${completed} of ${tasks.length} tasks completed`);

        tasks.forEach(task => {
          if (progress[task]) {
            $(`#${task}Reminder`).hide();
          } else {
            $(`#${task}Reminder`).show();
          }
        });

        if (completed === tasks.length) {
          $('.progress-container').hide();
          $('#alertsRow').hide();
          $('.page-header p').text("Welcome to MV Yuri Smart Induction. Your onboarding is complete. You can now fully use the dashboard.");
          $('#onboardingSuccess').fadeIn();
          showAlert('Onboarding complete! You can now fully use the dashboard.', 'success');
          logCrewActivity("Onboarding completed", "All tasks done");
        } else {
          $('.progress-container').show();
          $('#alertsRow').show();
          $('#onboardingSuccess').hide();
          $('.page-header p').text(
            "Welcome to MV Yuri Smart Induction. Your registration is complete. To continue, please complete your onboarding tasks below."
          );
        }
      }

      updateProgress();

      // CTA click
      $('.complete-task').on('click', function () {
        const task = $(this).data('task');
        progress[task] = true;
        saveProgress();
        updateProgress();
        showAlert(`Task "${task}" completed!`, 'success');

        logCrewActivity(`Completed task: ${task}`);

        const urlMap = {
          embark: 'crew-registration.html',
          cert: 'crew-certificates.html',
          gdpr: 'crew-gdpr.html',
          video: 'crew-familiarization.html'
        };
        window.location.href = urlMap[task];
      });

      // Auto-sync if config changes in another tab
      window.addEventListener('storage', function (e) {
        if (e.key === 'vesselConfig') {
          const updated = JSON.parse(e.newValue);
          renderCrewLogs(updated.logs);
        }
      });

    });
  </script>


</body>

</html>