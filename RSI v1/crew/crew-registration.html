<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>RSI Crew â€¢ My Profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../assets/ripple.css" rel="stylesheet" />
    <link href="page.css" rel="stylesheet" />
    <style>
        .nav-tabs { border-bottom: 2px solid #ddd; }
        .nav-tabs > li > a { border-radius: 4px 4px 0 0; padding: 12px 20px; font-size: 16px; color: var(--r-gray); border: 2px solid transparent; border-bottom: none; margin-right: 5px; }
        .nav-tabs > li.active > a, .nav-tabs > li.active > a:hover, .nav-tabs > li.active > a:focus { color: var(--r-blue); background-color: #fff; border-color: #ddd; border-bottom-color: transparent; font-weight: 600; }
        .nav-tabs > li > a:hover { background-color: #f9f9f9; border-color: #eee; border-bottom-color: transparent; }
        .tab-content { background-color: #fff; padding: 25px; border: 1px solid #ddd; border-top: none; border-radius: 0 0 12px 12px; box-shadow: 0 2px 6px rgba(0,0,0,.05); }
        label.required-field::after { content: " *"; color: var(--r-red); }
    </style>
</head>
<body>
    <div class="container-fluid dashboard-layout">
        <div class="row">
            <div id="sidebar-placeholder"></div>
            <div class="col-sm-9 col-md-10 main-content">
                <div class="page-header">
                    <h2>My Profile</h2>
                    <p id="page-instructions">View and maintain your registration details.</p>
                </div>
                
                <ul class="nav nav-tabs" id="profileTabs" role="tablist"></ul>
                <div class="tab-content" id="profileTabContent"></div>
            </div>
        </div>
    </div>

    <div class="sticky-footer">
        <div class="footer-container" id="footer-btn-container"></div>
    </div>

    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script>
    $(function () {
        // --- INITIALIZATION & DATA ---
         fetch('crew-sidebar.html')
            .then(res => res.text())
            .then(html => {
                $('#sidebar-placeholder').html(html);
                $('[data-page="crew-registration"]').addClass('active');
            });
        const configKey = "registrationFormConfig_v4";
        
        // *** DATA FIX: Added complete data for nok1 and nok2 ***
        const crewProfileData = {
            firstName: "Cloud", lastName: "Strife", gender: "Male", dob: "1986-08-11",
            pob: "Nibelheim", nationality: "Filipino", address: "123 Port Street, Manila", phone: "+63 2 123 4567", mobile: "+63 917 123 4567",
            company: "Ripple Shipping Inc.", rank: "Chief Engineer", emergencyContact: "+63 2 765 4321", passport: "passport.pdf",
            email: "cloud.strife@email.com",
            // NOK 1 Data
            nok1_rel: "Friend", nok1_fname: "Tifa", nok1_lname: "Lockhart", nok1_address: "Sector 7, Midgar", nok1_residence: "Philippines", nok1_phone: "+63 2 555 2222", nok1_mobile: "+63 917 555 2222", nok1_email: "tifa@email.com",
            // NOK 2 Data
            nok2_rel: "Friend", nok2_fname: "Barret", nok2_lname: "Wallace", nok2_address: "Sector 7, Midgar", nok2_residence: "Philippines", nok2_phone: "", nok2_mobile: "+63 918 555 3333", nok2_email: ""
        };

        const lockedFields = { personal: [ { id: 'firstName', label: 'First Name', type: 'text', required: true }, { id: 'lastName', label: 'Surname', type: 'text', required: true }, { id: 'gender', label: 'Gender', type: 'select', required: true, options: 'Male,Female,Other' }, { id: 'dob', label: 'Date of Birth', type: 'date', required: true } ], company: [ { id: 'company', label: 'Company', type: 'text', required: true }, { id: 'rank', label: 'Position / Rank', type: 'select', required: true, options: 'Captain,Chief Engineer,Deck Officer,AB Seaman' } ], account: [ { id: 'email', label: 'Email (Username)', type: 'email', required: true }] };
        let originalValues = {};

        // --- CORE FUNCTIONS ---
        function toggleViewMode(isEditing) {
            const footer = $('#footer-btn-container');
            const inputs = $('.profile-input');
            if (isEditing) {
                originalValues = {};
                inputs.each(function () { originalValues[this.id] = $(this).val(); });
                inputs.prop('readonly', false);
                footer.html(`<div class="row"><div class="col-xs-6"><button id="cancelBtn" class="btn btn-danger btn-block btn-sm"><i class="fa fa-times"></i> Cancel</button></div><div class="col-xs-6"><button id="saveBtn" class="btn btn-success btn-block btn-sm"><i class="fa fa-save"></i> Save Changes</button></div></div>`);
            } else {
                inputs.prop('readonly', true);
                footer.html('<button id="editBtn" class="btn btn-primary btn-block btn-sm"><i class="fa fa-pencil"></i> Edit Profile</button>');
            }
        }

        function loadAndRenderForm() {
            const configData = JSON.parse(localStorage.getItem(configKey));
            let sections = (configData && configData.sections) ? JSON.parse(JSON.stringify(configData.sections)) : [{ id: 'personal', title: 'Personal Information', fields: [] }];
            if (configData && configData.instructions) { $('#page-instructions').text(configData.instructions); }
            
            const personalSection = sections.find(s => s.title.toLowerCase().includes('personal')) || sections[0];
            personalSection.fields.unshift(...lockedFields.personal);
            let companySection = sections.find(s => s.title.toLowerCase().includes('company'));
            if (!companySection) { companySection = { id: generateUniqueId('sec'), title: 'Company Information', fields: [] }; sections.push(companySection); }
            companySection.fields.unshift(...lockedFields.company);
            personalSection.fields.push(...lockedFields.account);

            const tabs = $('#profileTabs').empty();
            const content = $('#profileTabContent').empty();
            let nokCounter = 1;

            sections.forEach((section, index) => {
                const visibleFields = section.fields.filter(f => f.visible !== false);
                if (visibleFields.length === 0) return;
                
                const sectionId = `section_${section.id}`;
                tabs.append(`<li class="${index === 0 ? 'active' : ''}"><a href="#${sectionId}" role="tab" data-toggle="tab">${section.title}</a></li>`);
                const tabPane = $(`<div class="tab-pane ${index === 0 ? 'active' : ''}" id="${sectionId}"><form class="row"></form></div>`).appendTo(content);
                const form = tabPane.find('form');

                visibleFields.forEach(field => {
                    let dataLookupId = field.id;
                    // *** LOGIC FIX: Create the correct ID for looking up NOK data ***
                    if (section.type === 'nok') {
                        dataLookupId = `nok${nokCounter}_${field.id.replace('nok_', '')}`;
                    }
                    const value = crewProfileData[dataLookupId] || '';
                    const inputHtml = `<input type="${field.type}" class="form-control profile-input" id="${dataLookupId}" value="${value}" readonly>`;
                    form.append(`<div class="col-sm-6 form-group"><label class="${field.required ? 'required-field' : ''}">${field.label}</label>${inputHtml}</div>`);
                });

                if (section.type === 'nok') {
                    nokCounter++;
                }
            });
        }
        
        // --- EVENT HANDLERS ---
        const footerContainer = $('#footer-btn-container');
        footerContainer.on('click', '#editBtn', () => toggleViewMode(true));
        footerContainer.on('click', '#saveBtn', function() {
            alert('Profile updated successfully! (Simulation)');
            toggleViewMode(false);
        });
        footerContainer.on('click', '#cancelBtn', function() {
            $('.profile-input').each(function () { $(this).val(originalValues[this.id]); });
            toggleViewMode(false);
        });

        function generateUniqueId(prefix = 'id_') { return prefix + Date.now(); }

        // --- INITIAL LOAD ---
        loadAndRenderForm();
        toggleViewMode(false);
    });
    </script>
</body>
</html>