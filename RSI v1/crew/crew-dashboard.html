<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>RSI Crew • Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <link href="../assets/ripple.css" rel="stylesheet" />
  <link href="page.css" rel="stylesheet" />
  <style>
    /* This style normalizes the font size of text from the Summernote editor */
    .welcome-content p,
    .welcome-content li,
    .welcome-content span {
      font-size: 16px;
      color: var(--r-gray);
    }

    .welcome-content h1,
    .welcome-content h2,
    .welcome-content h3,
    .welcome-content h4,
    .welcome-content h5,
    .welcome-content h6 {
      color: var(--r-dark);
      margin-top: 15px;
      margin-bottom: 10px;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div class="container-fluid dashboard-layout">
    <div class="row">
      <div id="sidebar-placeholder"></div>

      <div class="col-sm-9 col-md-10 main-content">

        <div class="progress-container">
          <div class="clearfix">
            <span class="pull-left"><strong>Onboarding Progress</strong></span>
            <span class="pull-right" id="progressText">0 of 3 tasks completed</span>
          </div>
          <div class="progress progress-with-steps">
            <div id="progressBar" class="progress-bar progress-bar-success progress-bar-striped active"
              role="progressbar" style="width: 0%;"></div>
            <div class="progress-steps">
              <span class="step" style="left: 0%;">Certificates</span>
              <span class="step" style="left: 50%;">GDPR</span>
              <span class="step" style="left: 100%;">Video</span>
            </div>
          </div>
        </div>

        <div class="page-header" id="welcome-container">
          <h2>Hi, Crew Member!</h2>
          <p>Welcome to the M/V Yurisan Dozo Smart Induction Portal.</p>
        </div>

        <div class="voyage-panel">
          <h4><i class="fa fa-calendar"></i> Your Embarkation Details</h4>
          <div class="voyage-details">
            <div><strong>Date</strong><span id="embarkDateDisplay">—</span></div>
            <div><strong>Time</strong><span id="embarkTimeDisplay">—</span></div>
            <div><strong>Location</strong><span id="embarkLocationDisplay">—</span></div>
          </div>
          <div class="text-right" style="margin-top:15px;">
            <a href="crew-vessel-info.html" class="btn btn-light-blue btn-block">
              <i class="fa fa-ship"></i> Explore M/V Yurisan Dozo
            </a>
          </div>
        </div>

        <div class="panel alerts-panel">
          <div class="panel-heading"><i class="fa fa-bell"></i> Alerts & Notifications</div>
          <div class="panel-body">
            <div id="reminders">
              <div class="alert alert-info">
                <span><i class="fa fa-info-circle"></i> <b>FYI:</b> New safety protocols will be discussed during the
                  briefing on Monday.</span>
              </div>
              <div class="alert alert-warning" id="certReminder">
                <span><i class="fa fa-upload"></i> <b>FYA:</b> Upload your certificates.</span>
                <button class="btn btn-xs btn-primary complete-task" data-task="cert">Upload</button>
              </div>
              <div class="alert alert-warning" id="gdprReminder">
                <span><i class="fa fa-shield"></i> <b>FYA:</b> Review GDPR agreement.</span>
                <button class="btn btn-xs btn-primary complete-task" data-task="gdpr">Review</button>
              </div>
              <div class="alert alert-warning" id="videoReminder">
                <span><i class="fa fa-video-camera"></i> <b>FYA:</b> Watch familiarization video.</span>
                <button class="btn btn-xs btn-primary complete-task" data-task="video">Watch</button>
              </div>
              <div class="alert alert-success" id="onboardingSuccess" style="display: none;">
                <i class="fa fa-check-circle"></i> <b>Onboarding Complete!</b> All tasks are done.
              </div>
            </div>
          </div>
        </div>

        <div class="panel" id="activityLogsPanel">
          <div class="panel-heading"><i class="fa fa-history"></i> Activity Logs</div>
          <div class="panel-body">
            <table class="table table-striped table-bordered" id="crewLogsTable">
              <thead>
                <tr></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="panel" id="vesselHistoryPanel">
          <div class="panel-heading"><i class="fa fa-ship"></i> Vessel History</div>
          <div class="panel-body">
            <table class="table table-striped table-bordered" id="vesselHistoryTable">
              <thead>
                <tr></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script>
    // --- UTILITY & DATA FUNCTIONS ---
    function showAlert(msg, type = 'success') {
      const alert = $(`<div class="alert alert-${type}" style="position:fixed;top:20px;right:20px;z-index:9999;">${msg}</div>`);
      $('body').append(alert);
      setTimeout(() => alert.fadeOut(500, () => alert.remove()), 3000);
    }

    function logCrewActivity(activity, remarks = '') {
      const storedData = localStorage.getItem("vesselPageData");
      let config = storedData ? JSON.parse(storedData) : {};
      if (!config.logs) config.logs = { columns: ['Date', 'Activity', 'Remarks'], entries: [] };
      if (!config.logs.entries) config.logs.entries = [];
      const cols = config.logs.columns || ['Date', 'Activity', 'Remarks'];
      const newEntry = {};
      const now = new Date();
      cols.forEach(col => {
        const lowerCol = col.toLowerCase();
        if (lowerCol === 'date') newEntry[col] = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
        else if (lowerCol === 'activity') newEntry[col] = activity;
        else if (lowerCol === 'remarks') newEntry[col] = remarks;
        else newEntry[col] = 'N/A';
      });
      config.logs.entries.unshift(newEntry);
      localStorage.setItem("vesselPageData", JSON.stringify(config));
    }

    function renderTable(tableId, config, defaultCols, noDataMsg) {
      const table = $(`#${tableId}`);
      const thead = table.find('thead tr').empty();
      const tbody = table.find('tbody').empty();
      const columns = (config && config.columns && config.columns.length > 0) ? config.columns : defaultCols;
      const entries = (config && config.entries) || [];
      const count = (config && config.count) || 5;
      columns.forEach(col => thead.append(`<th>${col}</th>`));
      if (entries.length > 0) {
        entries.slice(0, count).forEach(entry => {
          let rowHtml = '<tr>';
          columns.forEach(col => { rowHtml += `<td>${entry[col] || '—'}</td>`; });
          rowHtml += '</tr>';
          tbody.append(rowHtml);
        });
      } else {
        tbody.html(`<tr><td colspan="${columns.length}" class="text-center text-muted">${noDataMsg}</td></tr>`);
      }
    }

    $(function () {
      $('#sidebar-toggle').on('click', function () {
        $('.sidebar').toggleClass('active');
      });
      // Load sidebar
      fetch('crew-sidebar.html')
        .then(r => r.text())
        .then(data => {
          $('#sidebar-placeholder').html(data);
          $('[data-page="crew-dashboard"]').addClass('active');
        });

      const vesselData = JSON.parse(localStorage.getItem("vesselPageData")) || {};
      const settingsData = JSON.parse(localStorage.getItem("customerSettings")) || {};

      // --- ONBOARDING LOGIC ---
      const tasks = ['cert', 'gdpr', 'video'];
      let progress = JSON.parse(localStorage.getItem("progress")) || {};

      function saveProgress() {
        localStorage.setItem("progress", JSON.stringify(progress));
      }

      function updateProgress() {
        const completed = tasks.filter(t => progress[t]).length;
        const progressPercent = (completed / tasks.length) * 100;
        $('#progressBar').css('width', progressPercent + '%');
        $('#progressText').text(`${completed} of ${tasks.length} tasks completed`);

        tasks.forEach(task => {
          $(`#${task}Reminder`).toggle(!progress[task]);
        });

        if (completed === tasks.length) {
          $('.progress-container').hide();
          $('#onboardingSuccess').show();
        }
      }

      $('.complete-task').on('click', function () {
        const task = $(this).data('task');
        progress[task] = true;
        saveProgress();
        showAlert(`Task "${task.toUpperCase()}" marked as complete!`, 'success');
        logCrewActivity(`Onboarding task completed: ${task}`);
        updateProgress();
      });


      // --- PAGE INITIALIZATION ---
      // 1. Display Welcome Message
      if (settingsData.welcomeText) {
        let welcomeMsg = settingsData.welcomeText.replace(/{User}/g, 'Cloud Strife').replace(/{Vessel}/g, 'M/V Yurisan Dozo');
        $('#welcome-container').html(`<div class="welcome-content">${welcomeMsg}</div>`);
      }

      // 2. Display Embarkation Details
      if (vesselData.embarkation) {
        $('#embarkDateDisplay').text(vesselData.embarkation.date || '—');
        $('#embarkTimeDisplay').text(vesselData.embarkation.time || '—');
        $('#embarkLocationDisplay').text(vesselData.embarkation.location || '—');
      }

      // 3. Initialize Onboarding Progress
      updateProgress();

      // 4. Display Activity Logs (if enabled)
      if (settingsData.showActivityLogs) {
        $('#activityLogsPanel').show();
        const logConfig = vesselData.logs || {};
        logConfig.count = settingsData.activityLogCount;
        renderTable('crewLogsTable', logConfig, ['Date', 'Activity', 'Remarks'], 'No activity logs found.');
      } else {
        $('#activityLogsPanel').hide();
      }

      // 5. Display Vessel History (if enabled)
      if (settingsData.showVesselHistory) {
        $('#vesselHistoryPanel').show();
        const historyConfig = {
          columns: ['Vessel', 'Embark Date', 'Disembark Date'],
          entries: [
            { 'Vessel': 'M/V Ocean Dream', 'Embark Date': '2024-01-15', 'Disembark Date': '2024-07-20' },
            { 'Vessel': 'M/V Sea Spirit', 'Embark Date': '2023-05-10', 'Disembark Date': '2023-11-25' },
          ],
          count: settingsData.vesselHistoryCount
        };
        renderTable('vesselHistoryTable', historyConfig, ['Vessel', 'Embark Date', 'Disembark Date'], 'No vessel history found.');
      } else {
        $('#vesselHistoryPanel').hide();
      }
    });
  </script>
</body>

</html>