<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>RSI Crew • Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSS libs -->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <!-- Ripple CSS (Overpass, colors, etc.) -->
  <link href="../assets/ripple.css" rel="stylesheet">

  <style>
    body {
      background: #f3f6fb;
      font-family: var(--r-font, "Overpass", sans-serif);
      padding: 20px 10px 40px;
    }

    /* BRANDING BAR */
    .rsi-branding-bar {
      max-width: 1200px;
      margin: 0 auto 16px;
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e6ecf3;
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(7, 10, 26, 0.06);
    }

    .branding-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .company-logo {
      height: 44px;
      max-width: 120px;
      object-fit: contain;
    }

    .rsi-title-block h1 {
      font-size: 20px;
      margin: 0;
      font-weight: 700;
      color: var(--r-dark);
    }

    .rsi-title-block p {
      margin: 2px 0 0;
      font-size: 13px;
      color: #6B84A8;
    }

    .rsi-title-block .badge-pill {
      background: #f0f4ff;
      border-radius: 999px;
      padding: 2px 10px;
      display: inline-block;
      font-size: 11px;
      color: #3f5c8f;
      margin-top: 3px;
    }

    .branding-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .powered-text {
      font-size: 11px;
      color: #6B84A8;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .ripple-powered-logo {
      height: 26px;
      opacity: 0.95;
    }

    /* MAIN SHELL */
    .rsi-registration-shell {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(7, 10, 26, 0.08);
      overflow: hidden;
      min-height: 640px;
    }

    .sidebar {
      background: radial-gradient(circle at top, #1a2440 0, #070a1a 55%, #050713 100%);
      color: var(--r-light);
      padding: 28px 22px;
      height: 100%;
      position: relative;
    }

    .sidebar-header {
      margin-bottom: 30px;
    }

    .sidebar-header .rsi-mini-title {
      font-size: 11px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      opacity: 0.7;
    }

    .sidebar-header h2 {
      font-size: 19px;
      margin: 4px 0 3px;
      font-weight: 600;
    }

    .sidebar-header p {
      font-size: 12px;
      opacity: 0.8;
      margin: 0;
    }

    .sidebar-company-chip {
      margin-top: 10px;
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
      font-size: 11px;
      gap: 6px;
    }

    .sidebar-company-chip i {
      font-size: 12px;
      opacity: 0.9;
    }

    /* Stepper */
    .step-indicator {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-bottom: 30px;
    }

    .step {
      display: flex;
      align-items: center;
      padding: 10px 10px;
      border-radius: 8px;
      cursor: pointer;
      position: relative;
      transition: all 0.25s ease;
    }

    .step.active {
      background: rgba(255, 255, 255, 0.06);
      transform: translateX(4px);
    }

    .step.completed {
      opacity: 0.85;
    }

    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 13px;
      font-weight: 600;
    }

    .step.active .step-number {
      background: var(--r-green);
      color: var(--r-dark);
      border-color: var(--r-green);
    }

    .step.completed .step-number {
      background: var(--r-green);
      color: var(--r-dark);
      border-color: var(--r-green);
    }

    .step.completed .step-number span {
      display: none;
    }

    .step.completed .step-number i {
      display: block;
    }

    .step-number i {
      display: none;
    }

    .step-info-title {
      font-size: 13px;
      font-weight: 600;
    }

    .step-info-desc {
      font-size: 11px;
      opacity: 0.75;
    }

    .sidebar-footer {
      position: absolute;
      bottom: 16px;
      left: 22px;
      right: 22px;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
    }

    .sidebar-footer i {
      margin-right: 4px;
    }

    /* MAIN CONTENT */
    .main-content {
      padding: 26px 26px 20px;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .progress-bar-shell {
      height: 6px;
      background: #eef2fb;
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 18px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(to right, var(--r-blue), var(--r-orange));
      width: 0%;
      transition: width 0.35s ease;
    }

    .instructions-block {
      margin-bottom: 18px;
      font-size: 13px;
      color: #5e7196;
      background: #f6f8fd;
      border-radius: 8px;
      padding: 10px 12px;
      border: 1px solid #e2e8f5;
    }

    .instructions-block i {
      margin-right: 6px;
      color: var(--r-blue);
    }

    .form-section {
      display: none;
      flex-grow: 1;
      animation: fadeIn 0.3s ease;
    }

    .form-section.active {
      display: block;
    }

    .form-section-header {
      margin-bottom: 15px;
    }

    .form-section-header h2 {
      font-size: 20px;
      margin: 0 0 4px;
      font-weight: 600;
      color: var(--r-dark);
    }

    .form-section-header p {
      margin: 0;
      font-size: 13px;
      color: #6B84A8;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .required-field::after {
      content: " *";
      color: var(--r-red);
      font-weight: 600;
    }

    .form-control {
      border-radius: 6px;
      border: 1px solid #d6deee;
      box-shadow: none;
      font-size: 14px;
      padding: 8px 10px;
      height: auto;
    }

    .form-control:focus {
      border-color: var(--r-blue);
      box-shadow: 0 0 0 1px rgba(63, 145, 255, 0.20);
    }

    .has-error .form-control {
      border-color: var(--r-red);
    }

    .validation-error {
      font-size: 11px;
      color: var(--r-red);
    }

    .file-input {
      padding: 6px 8px;
    }

    /* REVIEW SECTION */
    .review-wrapper {
      padding-top: 4px;
    }

    .review-block {
      border: 1px solid #e0e6f5;
      border-radius: 8px;
      padding: 12px 14px;
      margin-bottom: 12px;
      background: #fbfcff;
    }

    .review-block h3 {
      font-size: 14px;
      margin: 0 0 8px;
      color: var(--r-blue);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .review-row {
      display: flex;
      font-size: 13px;
      padding: 3px 0;
      border-bottom: 1px dashed #e4e9f6;
    }

    .review-row:last-child {
      border-bottom: none;
    }

    .review-label {
      width: 40%;
      color: #6B84A8;
    }

    .review-value {
      width: 60%;
      color: #2e3b59;
      word-break: break-word;
    }

    /* Consent block before submit */
    .review-consent {
      margin-top: 16px;
      padding: 10px 12px;
      border-radius: 6px;
      background: #f6f8fd;
      border: 1px solid #e2e8f5;
      font-size: 12px;
      color: #5e7196;
    }

    .review-consent .checkbox {
      margin: 0;
    }

    /* SUCCESS SCREEN */
    .success-screen {
      display: none;
      text-align: center;
      padding: 40px 10px;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex-grow: 1;
    }

    .success-screen.active {
      display: flex;
    }

    .success-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--r-green);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 18px;
      color: #fff;
      font-size: 34px;
    }

    .success-screen h2 {
      font-size: 22px;
      margin-bottom: 8px;
      color: var(--r-dark);
    }

    .success-screen p {
      font-size: 13px;
      color: #6B84A8;
      max-width: 420px;
      margin: 0 auto 18px;
    }

    .final-message-container {
      margin-bottom: 16px;
      font-size: 13px;
      color: #6B84A8;
      max-width: 480px;
    }

    .final-message-container .checkbox {
      margin-top: 8px;
    }

    .onboarding-tasks {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin: 12px 0 18px;
    }

    .onboarding-tasks .task {
      background: #f6f8fd;
      border: 1px solid #e2e8f5;
      border-radius: 8px;
      padding: 14px 10px;
      text-align: center;
      flex: 1;
      min-width: 150px;
    }

    .onboarding-tasks .task i {
      font-size: 20px;
      margin-bottom: 6px;
      color: var(--r-blue);
    }

    .onboarding-tasks .task h3 {
      font-size: 14px;
      margin: 4px 0;
      color: #2e3b59;
    }

    .onboarding-tasks .task p {
      font-size: 12px;
      color: #6B84A8;
      margin: 0;
    }

    /* FOOTER NAV */
    .form-footer {
      border-top: 1px solid #e3e9f5;
      padding-top: 12px;
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .step-counter {
      font-size: 12px;
      color: #6B84A8;
    }

    .btn-outline {
      background: #ffffff;
      border: 1px solid #d6deee;
      color: #2e3b59;
    }

    .btn-outline:hover {
      background: #f5f7fc;
    }

    .btn-primary {
      background: var(--r-blue);
      border-color: var(--r-blue);
    }

    .btn-primary:hover {
      background: #3375d8;
    }

    .btn-success {
      background: var(--r-green);
      border-color: var(--r-green);
    }

    /* RESPONSIVE */
    @media (max-width: 992px) {
      .sidebar {
        padding: 22px 18px;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 10px 5px 30px;
      }

      .rsi-branding-bar {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .rsi-registration-shell {
        border-radius: 10px;
      }

      .sidebar {
        min-height: auto;
        position: static;
      }

      .sidebar-footer {
        position: static;
        margin-top: 18px;
      }

      .form-footer {
        flex-direction: column;
        align-items: stretch;
      }

      .form-footer .btn {
        width: 100%;
      }

      .onboarding-tasks {
        flex-direction: column;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(6px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <!-- TOP BRANDING BAR -->
  <div class="rsi-branding-bar">
    <div class="branding-left">
      <img id="companyLogo" src="../assets/company-logo.png" alt="Company Logo" class="company-logo">
      <div class="rsi-title-block">
        <h1>Hana No Umi Logistics</h1>
        <p>Ripple Smart Induction • <span id="companyName">Crew Registration</span></p>
        <span class="badge-pill" id="vesselTag" style="display:none;">
          <i class="fa fa-ship"></i> <span id="vesselName"></span>
        </span>
      </div>
    </div>
    <div class="branding-right">
      <span class="powered-text">Powered by</span>
      <img src="../assets/Logo-Color.png" class="ripple-powered-logo" alt="Ripple Operations">
    </div>
  </div>

  <!-- MAIN SHELL -->
  <div class="container-fluid rsi-registration-shell">
    <div class="row" style="min-height: 520px;">
      <!-- Sidebar (Steps) -->
      <div class="col-md-4 sidebar">
        <div class="sidebar-header">
          <div class="rsi-mini-title">Onboarding</div>
          <h2>Your registration steps</h2>
          <!-- This text will be replaced dynamically with formConfig.instructions -->
          <p id="sidebarInstruction">Please complete all required fields to start your induction.</p>
          <div class="sidebar-company-chip">
            <i class="fa fa-building"></i>
            <span id="sidebarCompanyName">Company</span>
          </div>
        </div>

        <div class="step-indicator" id="stepList">
          <!-- Steps generated by JS -->
        </div>

        <div class="sidebar-footer">
          <i class="fa fa-info-circle"></i>
          Your data is securely processed by Ripple Operations for induction purposes only.
        </div>
      </div>

      <!-- Main Content -->
      <div class="col-md-8 main-content">
        <div class="progress-bar-shell">
          <div class="progress-fill" id="progressBar"></div>
        </div>

        <!-- <div class="instructions-block" id="instructionsBlock" style="display:none;">
          <i class="fa fa-info-circle"></i>
          <span id="instructionsText"></span>
        </div> -->

        <!-- Dynamic form sections (per grouped step) -->
        <div id="formSectionsContainer"></div>

        <!-- Success screen -->
        <div class="success-screen" id="successScreen">
          <div class="success-icon"><i class="fa fa-check"></i></div>
          <h2 id="successTitle">Registration submitted!</h2>

          <!-- Final message from Customer Settings (after submit) -->
          <div id="finalMessageContainer" class="final-message-container"></div>

          <!-- What they can do next in Crew Portal -->
          <div class="row onboarding-tasks" id="onboardingTasks">
            <div class="col-sm-4 task">
              <i class="fa fa-upload"></i>
              <h3>Upload Certificates</h3>
              <p>Prepare and upload your training, medical, and license documents.</p>
            </div>
            <div class="col-sm-4 task">
              <i class="fa fa-video-camera"></i>
              <h3>Watch Induction</h3>
              <p>Complete the vessel-specific safety and familiarization video.</p>
            </div>
            <div class="col-sm-4 task" id="taskGdpr">
              <i class="fa fa-shield"></i>
              <h3>GDPR &amp; Data Privacy</h3>
              <p>Your personal data is handled securely in line with GDPR and company policies.</p>
            </div>
          </div>

          <a href="crew-login.html" class="btn btn-primary">
            <i class="fa fa-sign-in"></i> Back to login
          </a>
        </div>

        <!-- Footer navigation -->
        <div class="form-footer" id="footerNav">
          <button class="btn btn-outline btn-sm" id="prevBtn">
            <i class="fa fa-chevron-left"></i> Previous
          </button>

          <div class="step-counter">
            Step <span id="currentStep">1</span> of <span id="totalSteps">1</span>
          </div>

          <button class="btn btn-primary btn-sm" id="nextBtn">
            Next <i class="fa fa-chevron-right"></i>
          </button>

          <button class="btn btn-success btn-sm" id="submitBtn" style="display:none;">
            <i class="fa fa-paper-plane"></i> Submit Registration
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS libs -->
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

  <script>
    $(function () {
      // ==== KEYS & GLOBAL STATE ====
      const CONFIG_KEY = "registrationFormConfig_v4";
      const REG_CONFIG_BY_VESSEL_KEY = "registrationFormConfigsByVessel";
      const CUSTOMER_SETTINGS_KEY = "customerSettings";

      let formConfig = null;
      let sections = [];
      let steps = [];
      let currentStepIndex = 0;

      let vessels = [];
      let regConfigsByVessel = {};
      let currentVesselId = null;
      let customerSettings = null;

      // ---------- SAFE HELPERS ----------
      function safeParse(json, fallback) {
        try {
          if (!json) return fallback;
          return JSON.parse(json);
        } catch (e) {
          console.warn("JSON parse error:", e);
          return fallback;
        }
      }

      // ==== DEFAULT CONFIG (STATIC FIELDS FOR DEMO) ====
      function createDefaultConfig() {
        return {
          instructions: "Welcome. Please complete all required fields to create your Ripple Smart Induction crew account.",
          sections: [
            {
              id: "sec_personal",
              title: "Personal Details",
              type: "custom",
              fields: [
                { uniqueId: "fld_firstname", id: "locked_firstname", label: "First Name / Nickname", type: "text", visible: true, required: true, validation: "" },
                { uniqueId: "fld_surname", id: "locked_surname", label: "Surname", type: "text", visible: true, required: true, validation: "" },
                { uniqueId: "fld_gender", id: "locked_gender", label: "Gender", type: "select", visible: true, required: true, validation: "Male, Female, Other" },
                { uniqueId: "fld_dob", id: "locked_dob", label: "Date of Birth", type: "date", visible: true, required: true, validation: "" },
                { uniqueId: "fld_pob", id: "pob", label: "Place of Birth", type: "text", visible: true, required: false, validation: "" },
                { uniqueId: "fld_nationality", id: "nationality", label: "Nationality", type: "select", visible: true, required: true, validation: "Filipino, Norwegian, Greek, Other" },
                { uniqueId: "fld_address", id: "address", label: "Residence Address", type: "text", visible: true, required: true, validation: "" },
                { uniqueId: "fld_mobile", id: "mobile", label: "Mobile Number", type: "text", visible: true, required: true, validation: "" }
              ]
            },
            {
              id: "sec_company",
              title: "Company & Emergency Contact",
              type: "custom",
              fields: [
                { uniqueId: "fld_company", id: "locked_company", label: "Company", type: "text", visible: true, required: true, validation: "" },
                { uniqueId: "fld_position", id: "locked_position", label: "Position / Rank", type: "text", visible: true, required: true, validation: "" },
                { uniqueId: "fld_assigned_vessel", id: "locked_assigned_vessel", label: "Assigned Vessel", type: "select", visible: true, required: true, validation: "" },
                { uniqueId: "fld_embark_date", id: "locked_embarkation_date", label: "Embarkation Date", type: "date", visible: true, required: true, validation: "" },
                { uniqueId: "fld_emergency_contact", id: "emergencyContact", label: "Emergency Contact in Company", type: "text", visible: true, required: true, validation: "" }
              ]
            },
            {
              id: "sec_iddocs",
              title: "Identification Documents",
              type: "custom",
              fields: [
                { uniqueId: "fld_passport_no", id: "passport_no", label: "Passport Number", type: "text", visible: true, required: true, validation: "" },
                { uniqueId: "fld_passport_upload", id: "passport", label: "Passport Upload", type: "file", visible: true, required: true, fileRequired: true, validation: "PDF/JPG/PNG only" },
                { uniqueId: "fld_seamans_book", id: "seamans_book_no", label: "Seaman's Book Number", type: "text", visible: true, required: false, validation: "" },
                { uniqueId: "fld_nat_id", id: "nat_id", label: "National ID Upload", type: "file", visible: true, required: false, fileRequired: false, validation: "PDF/JPG/PNG only" }
              ]
            },
            {
              id: "sec_nok1",
              title: "Next of Kin 1",
              type: "nok",
              fields: [
                { uniqueId: "fld_nok1_rel", id: "nok_rel", label: "Relationship", type: "select", visible: true, required: true, validation: "Spouse, Parent, Sibling, Other" },
                { uniqueId: "fld_nok1_fname", id: "nok_fname", label: "First Name", type: "text", visible: true, required: true, validation: "" },
                { uniqueId: "fld_nok1_lname", id: "nok_lname", label: "Surname", type: "text", visible: true, required: true, validation: "" },
                { uniqueId: "fld_nok1_address", id: "nok_address", label: "Address", type: "text", visible: true, required: true, validation: "" },
                { uniqueId: "fld_nok1_res", id: "nok_residence", label: "Residence", type: "select", visible: true, required: true, validation: "Philippines, Norway, Greece" },
                { uniqueId: "fld_nok1_phone", id: "nok_phone", label: "Phone", type: "text", visible: true, required: false, validation: "" },
                { uniqueId: "fld_nok1_mobile", id: "nok_mobile", label: "Mobile", type: "text", visible: true, required: true, validation: "" },
                { uniqueId: "fld_nok1_email", id: "nok_email", label: "Email", type: "email", visible: true, required: false, validation: "" }
              ]
            },
            {
              id: "sec_nok2",
              title: "Next of Kin 2",
              type: "nok",
              fields: [
                { uniqueId: "fld_nok2_rel", id: "nok2_rel", label: "Relationship", type: "select", visible: true, required: false, validation: "Spouse, Parent, Sibling, Friend, Other" },
                { uniqueId: "fld_nok2_fname", id: "nok2_fname", label: "First Name", type: "text", visible: true, required: false, validation: "" },
                { uniqueId: "fld_nok2_lname", id: "nok2_lname", label: "Surname", type: "text", visible: true, required: false, validation: "" },
                { uniqueId: "fld_nok2_address", id: "nok2_address", label: "Address", type: "text", visible: true, required: false, validation: "" },
                { uniqueId: "fld_nok2_res", id: "nok2_residence", label: "Residence", type: "select", visible: true, required: false, validation: "Philippines, Norway, Greece" },
                { uniqueId: "fld_nok2_phone", id: "nok2_phone", label: "Phone", type: "text", visible: true, required: false, validation: "" },
                { uniqueId: "fld_nok2_mobile", id: "nok2_mobile", label: "Mobile", type: "text", visible: true, required: false, validation: "" },
                { uniqueId: "fld_nok2_email", id: "nok2_email", label: "Email", type: "email", visible: true, required: false, validation: "" }
              ]
            },
            {
              id: "sec_account",
              title: "Account Setup",
              type: "custom",
              fields: [
                { uniqueId: "fld_email", id: "locked_email", label: "Email (Username)", type: "email", visible: true, required: true, validation: "" },
                { uniqueId: "fld_password", id: "locked_password", label: "Password", type: "password", visible: true, required: true, validation: "" },
                { uniqueId: "fld_password_confirm", id: "locked_password_confirm", label: "Confirm Password", type: "password", visible: true, required: true, validation: "" }
              ]
            }
          ]
        };
      }

      function ensureConfigHasSections() {
        if (!formConfig || !Array.isArray(formConfig.sections) || !formConfig.sections.length) {
          console.warn("Config has no sections – falling back to default static config");
          formConfig = createDefaultConfig();
        }
      }

      // ==== CACHE DOM ELEMENTS ====
      const stepListEl = $("#stepList");
      const formSectionsContainer = $("#formSectionsContainer");
      const progressBar = $("#progressBar");
      const currentStepDisplay = $("#currentStep");
      const totalStepsDisplay = $("#totalSteps");
      const prevBtn = $("#prevBtn");
      const nextBtn = $("#nextBtn");
      const submitBtn = $("#submitBtn");
      const successScreen = $("#successScreen");
      const footerNav = $("#footerNav");
      const sidebarInstructionEl = $("#sidebarInstruction");

      // ==== LOAD BASIC DATA ====
      vessels = safeParse(localStorage.getItem("vessels"), []);
      if (!vessels.length) {
        vessels = [
          { id: "VES-001", name: "M/V Ocean Explorer" },
          { id: "VES-002", name: "M/V Yurisan Dozo" },
          { id: "VES-003", name: "M/V Ripple Star" }
        ];
        localStorage.setItem("vessels", JSON.stringify(vessels));
      }

      regConfigsByVessel = safeParse(localStorage.getItem(REG_CONFIG_BY_VESSEL_KEY), {});
      customerSettings = safeParse(localStorage.getItem(CUSTOMER_SETTINGS_KEY), null);

      const urlParams = new URLSearchParams(window.location.search);
      const queryVesselId = urlParams.get("vesselId");
      const storedRegVesselId = localStorage.getItem("regCurrentVesselId");

      if (queryVesselId) {
        currentVesselId = queryVesselId;
      } else if (storedRegVesselId) {
        currentVesselId = storedRegVesselId;
      } else if (vessels.length) {
        currentVesselId = vessels[0].id;
      }

      const branding = safeParse(localStorage.getItem("customerBranding"), {});
      const companyName = branding.companyName || "Hana No Umi Logistics";
      const companyLogo = branding.logoUrl || "../assets/company-logo.png";

      $("#companyName").text(companyName);
      $("#sidebarCompanyName").text(companyName);
      $("#companyLogo").attr("src", companyLogo);

      if (currentVesselId && vessels.length) {
        const v = vessels.find(x => x.id === currentVesselId);
        if (v) {
          $("#vesselName").text(v.name);
          $("#vesselTag").show();
        }
      }

      // ==== STEP GROUPING MODEL ====
      function buildStepsModel() {
        steps = [];

        function ensureStep(key, title, desc) {
          let s = steps.find(st => st.key === key);
          if (!s) {
            s = { key: key, title: title, description: desc, sections: [] };
            steps.push(s);
          }
          return s;
        }

        sections.forEach(sec => {
          const title = sec.title || "";
          const lower = title.toLowerCase();

          let stepKey, stepTitle, stepDesc;

          if (lower.indexOf("personal") !== -1 || lower.indexOf("profile") !== -1) {
            // PERSONAL step
            stepKey = "personal";
            stepTitle = "Personal Details";
            stepDesc = "Your basic personal information.";
          } else if (lower.indexOf("company") !== -1 || lower.indexOf("emergency") !== -1) {
            // COMPANY step
            stepKey = "company";
            stepTitle = "Company & Emergency Contact";
            stepDesc = "Your employment and company emergency contact.";
          } else if (lower.indexOf("identification") !== -1 || lower.indexOf("id ") !== -1 || lower.indexOf("passport") !== -1) {
            stepKey = "ids";
            stepTitle = "Identification Documents";
            stepDesc = "Your passport and official documents.";
          } else if (lower.indexOf("next of kin") !== -1 || lower.indexOf("nok") !== -1) {
            stepKey = "nok";
            stepTitle = "Next of Kin";
            stepDesc = "Emergency contact details.";
          } else if (lower.indexOf("account") !== -1 || lower.indexOf("login") !== -1 || lower.indexOf("credentials") !== -1) {
            stepKey = "account";
            stepTitle = "Account Setup";
            stepDesc = "Your login credentials.";
          } else {
            stepKey = "extra_" + sec.id;
            stepTitle = title || "Additional Information";
            stepDesc = "Provide the requested details.";
          }

          const step = ensureStep(stepKey, stepTitle, stepDesc);
          step.sections.push(sec);
        });

        if (!steps.length && sections.length) {
          steps.push({
            key: "all",
            title: "Registration",
            description: "Complete all required information.",
            sections: sections
          });
        }
      }

      // ==== RENDER UI (steps + form sections) ====
      function renderStepsAndSections() {
        stepListEl.empty();
        formSectionsContainer.empty();

        const total = steps.length + 1; // + review
        totalStepsDisplay.text(total);

        // Sidebar steps
        steps.forEach((step, idx) => {
          const stepEl = $('<div class="step"></div>').attr("data-step-index", idx);
          stepEl.append(
            '<div class="step-number"><span>' + (idx + 1) + '</span><i class="fa fa-check"></i></div>' +
            '<div>' +
            '<div class="step-info-title">' + step.title + '</div>' +
            '<div class="step-info-desc">' + step.description + '</div>' +
            '</div>'
          );
          stepListEl.append(stepEl);
        });

        // Review step
        const reviewIndex = steps.length;
        const reviewStepEl = $('<div class="step"></div>').attr("data-step-index", reviewIndex);
        reviewStepEl.append(
          '<div class="step-number"><span>' + (reviewIndex + 1) + '</span><i class="fa fa-check"></i></div>' +
          '<div>' +
          '<div class="step-info-title">Review &amp; Submit</div>' +
          '<div class="step-info-desc">Confirm your details</div>' +
          '</div>'
        );
        stepListEl.append(reviewStepEl);

        // Main sections per step
        steps.forEach((step, idx) => {
          const stepSec = $('<div class="form-section"></div>').attr("data-step-index", idx);
          const header = $('<div class="form-section-header"></div>');
          header.append('<h2>' + step.title + '</h2>');
          header.append('<p>' + step.description + '</p>');
          stepSec.append(header);

step.sections.forEach(sec => {
  const secTitle = sec.title || "";

  // Show section title only when:
  // - the step has more than one section, AND
  // - the section title is not identical to the step title
  if (step.sections.length > 1 && secTitle && secTitle !== step.title) {
    stepSec.append(
      '<h4 style="margin:10px 0 6px; font-size:14px; color:#3b4a6f;">' +
      secTitle +
      '</h4>'
    );
  }

  const row = $('<div class="row"></div>');
  stepSec.append(row);

  (sec.fields || [])
    .filter(f => f.visible !== false)
    .forEach(field => {
      const col = $('<div class="col-sm-6 form-group"></div>');
      const label = $('<label></label>').text(field.label || "");
      if (field.required) label.addClass("required-field");
      col.append(label);

      const uid = field.uniqueId || (field.id || ("fld_" + Date.now() + Math.random()));
      const baseAttrs = {
        id: uid,
        "data-uid": uid,
        "data-field-id": field.id || "",
        class: "form-control"
      };

      let inputEl;

      if (field.id === "locked_assigned_vessel") {
        inputEl = $("<select></select>", baseAttrs);
        inputEl.append('<option value="">Select vessel</option>');
        vessels.forEach(v => {
          inputEl.append('<option value="' + v.id + '">' + v.name + '</option>');
        });
      } else if (field.type === "select") {
        inputEl = $("<select></select>", baseAttrs);
        inputEl.append('<option value="">Select...</option>');
        const options = (field.validation || "").split(",").map(x => x.trim()).filter(Boolean);
        options.forEach(opt => {
          inputEl.append('<option value="' + opt + '">' + opt + '</option>');
        });
      } else if (field.type === "file") {
        inputEl = $("<input>", $.extend({}, baseAttrs, {
          type: "file",
          class: "form-control file-input"
        }));
      } else if (field.type === "textarea") {
        inputEl = $("<textarea></textarea>", $.extend({}, baseAttrs, { rows: 3 }));
      } else {
        const inputType = field.type === "password" ? "password" : (field.type || "text");
        inputEl = $("<input>", $.extend({}, baseAttrs, { type: inputType }));
      }

      col.append(inputEl);
      row.append(col);
    });
});


          formSectionsContainer.append(stepSec);
        });

        // Review section
        const reviewSection = $('<div class="form-section" id="reviewSection"></div>').attr("data-step-index", "review");
        reviewSection.append(
          '<div class="form-section-header">' +
          '<h2>Review &amp; Submit</h2>' +
          '<p>Confirm that all details are accurate before submitting your registration.</p>' +
          '</div>' +
          '<div class="review-wrapper" id="reviewWrapper"></div>' +
          '<div id="reviewConsentContainer" class="review-consent" style="display:none;"></div>'
        );
        formSectionsContainer.append(reviewSection);

        hookStepClick();
        updateUI();
      }

      function hookStepClick() {
        $("#stepList .step").off("click").on("click", function () {
          const target = parseInt($(this).attr("data-step-index"), 10);
          const maxIndex = steps.length; // last index is review
          if (isNaN(target)) return;
          if (target <= currentStepIndex) {
            currentStepIndex = target;
            updateUI();
          }
        });
      }

      // ==== NAV + UI ====
      function updateUI() {
        const total = steps.length + 1;
        totalStepsDisplay.text(total);

        $("#stepList .step").each(function () {
          const idx = parseInt($(this).attr("data-step-index"), 10);
          $(this).removeClass("active completed");
          if (idx === currentStepIndex) {
            $(this).addClass("active");
          } else if (idx < currentStepIndex) {
            $(this).addClass("completed");
          }
        });

        $(".form-section").removeClass("active");
        if (currentStepIndex < steps.length) {
          $('.form-section[data-step-index="' + currentStepIndex + '"]').addClass("active");
        } else {
          $('#reviewSection').addClass("active");
          populateReview();
          renderReviewConsentFromSettings();
        }

        const progressPercentage = ((currentStepIndex + 1) / (steps.length + 1)) * 100;
        progressBar.css("width", progressPercentage + "%");
        currentStepDisplay.text(currentStepIndex + 1);

        if (currentStepIndex === 0) {
          prevBtn.hide();
        } else {
          prevBtn.show();
        }

        if (currentStepIndex < steps.length) {
          nextBtn.show();
          submitBtn.hide();
        } else {
          nextBtn.hide();
          submitBtn.show();
        }

        successScreen.removeClass("active");
        formSectionsContainer.show();
        footerNav.show();
      }

      // Prev / Next (NO blocking validation for demo)
      prevBtn.on("click", function () {
        if (currentStepIndex > 0) {
          currentStepIndex--;
          updateUI();
        }
      });

      nextBtn.on("click", function () {
        if (currentStepIndex < steps.length) {
          // For demo: no blocking validation, just move to next step
          currentStepIndex++;
          updateUI();
        }
      });

      submitBtn.on("click", function () {
        // For demo, skip global validation and always show success
        const payload = collectFormData();
        console.log("Registration payload (demo):", payload);

        formSectionsContainer.hide();
        footerNav.hide();
        renderSuccessFromSettings();
        successScreen.addClass("active");
      });

      // ==== VALIDATION & DATA (kept for future if you want to re-enable) ====
      function validateStep(stepIndex) {
        const step = steps[stepIndex];
        if (!step) return true;

        let isValid = true;

        step.sections.forEach(sec => {
          (sec.fields || []).forEach(field => {
            if (!field.required || field.visible === false) return;

            const uid = field.uniqueId || field.id;
            const $control = $('[data-uid="' + uid + '"]');
            if (!$control.length) return;

            const $group = $control.closest(".form-group");
            $group.removeClass("has-error");
            $group.find(".validation-error").remove();

            let value = "";
            if (field.type === "file") {
              value = ($control[0].files && $control[0].files.length > 0) ? "uploaded" : "";
            } else {
              value = ($control.val() || "").trim();
            }

            if (!value) {
              isValid = false;
              $group.addClass("has-error");
              $group.append('<div class="validation-error">This field is required.</div>');
            }
          });
        });

        if (isValid && step.key === "account") {
          const pw = ($('[data-field-id="locked_password"]').val() || "");
          const pw2 = ($('[data-field-id="locked_password_confirm"]').val() || "");
          if (pw && pw2 && pw !== pw2) {
            const $group = $('[data-field-id="locked_password_confirm"]').closest(".form-group");
            $group.addClass("has-error");
            $group.find(".validation-error").remove();
            $group.append('<div class="validation-error">Passwords do not match.</div>');
            isValid = false;
          }
        }

        return isValid;
      }

      function validateAllSteps() {
        for (let i = 0; i < steps.length; i++) {
          if (!validateStep(i)) {
            currentStepIndex = i;
            updateUI();
            return false;
          }
        }
        return true;
      }

      function collectFormData() {
        const data = {
          vesselId: currentVesselId || null,
          companyName: $("#companyName").text(),
          steps: []
        };

        steps.forEach(step => {
          const stepData = { key: step.key, title: step.title, sections: [] };

          step.sections.forEach(sec => {
            const secData = { id: sec.id, title: sec.title, fields: [] };

            (sec.fields || []).forEach(field => {
              if (field.visible === false) return;

              const uid = field.uniqueId || field.id;
              const $control = $('[data-uid="' + uid + '"]');
              if (!$control.length) return;

              let value = "";
              if (field.type === "file") {
                const files = $control[0].files;
                value = files && files.length ? files[0].name : "";
              } else {
                value = $control.val();
              }

              secData.fields.push({
                id: field.id || uid,
                label: field.label,
                type: field.type,
                value: value
              });
            });

            stepData.sections.push(secData);
          });

          data.steps.push(stepData);
        });

        return data;
      }

      function populateReview() {
        const wrapper = $("#reviewWrapper").empty();
        const data = collectFormData();

        data.steps.forEach(step => {
          const block = $('<div class="review-block"></div>');
          block.append('<h3><i class="fa fa-folder-open"></i> ' + step.title + '</h3>');

          step.sections.forEach(sec => {
            (sec.fields || []).forEach(field => {
              if (!field.value) return;

              let value = field.value;
              if ((field.id || "").indexOf("password") !== -1) {
                value = "••••••••";
              }

              const row = $('<div class="review-row"></div>');
              row.append('<div class="review-label">' + (field.label || field.id) + '</div>');
              row.append('<div class="review-value">' + value + '</div>');
              block.append(row);
            });
          });

          wrapper.append(block);
        });
      }

      // ==== CONSENT CHECKBOX ON REVIEW (before submit) ====
      function renderReviewConsentFromSettings() {
        const container = $("#reviewConsentContainer");
        if (!container.length) return;
        container.empty();

        if (customerSettings && customerSettings.includeCheckbox) {
          const html =
            '<div class="checkbox">' +
            '<label>' +
            '<input type="checkbox" id="reviewConsentCheckbox">' +
            ' I approve sharing my information with the vessel and confirm that the details I have provided are accurate.' +
            '</label>' +
            '</div>';
          container.html(html).show();
        } else {
          container.hide();
        }
      }

      // ==== SUCCESS SCREEN CONTENT (from Customer Settings) ====
      function renderSuccessFromSettings() {
        const container = $("#finalMessageContainer").empty();

        // Final message HTML from settings (shown AFTER submit)
        if (customerSettings && customerSettings.finalMessage) {
          container.append(customerSettings.finalMessage);
        } else {
          container.append(
            '<p>' +
            'Thank you for completing your Ripple Smart Induction registration. Once your registration is approved, ' +
            'you can log in to the RSI Crew Portal to continue your onboarding.' +
            '</p>'
          );
        }
      }

      // ==== LOAD CONFIG & INIT ====
      function loadConfig() {
        const globalConfigRaw = localStorage.getItem(CONFIG_KEY);

        if (currentVesselId && regConfigsByVessel && regConfigsByVessel[currentVesselId]) {
          formConfig = regConfigsByVessel[currentVesselId];
        } else if (globalConfigRaw) {
          formConfig = safeParse(globalConfigRaw, null);
        } else {
          formConfig = null;
        }

        if (!formConfig) {
          formConfig = createDefaultConfig();
        }

        ensureConfigHasSections();
        sections = formConfig.sections;

        // General instruction -> Sidebar + info block
        if (formConfig.instructions) {
          $("#instructionsText").text(formConfig.instructions);
          $("#instructionsBlock").show();
          sidebarInstructionEl.text(formConfig.instructions);
        } else {
          $("#instructionsBlock").hide();
          // fallback text in sidebarInstructionEl stays as-is
        }

        buildStepsModel();
        renderStepsAndSections();
      }

      loadConfig();
    });
  </script>

</body>

</html>
